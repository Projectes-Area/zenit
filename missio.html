<!DOCTYPE html>
<html lang="ca">
	<head>
		<title>Missió</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				background-color: #000;	margin: 0 0 0 0; padding: 0 0 0 0; border: none; cursor: default;
				margin: 0 0 0 0;
				padding: 0 0 0 0;
				border: none;
				cursor: default;
				overflow: hidden;
			}
			#container {
				height: 100%;
				width: 100%;
				display: flex;
			}
			#content {
				width: 50%;
			}
			#content2 {
				width: 50%;
			}
			#dat {
				user-select: none; position: absolute; left: 0;	top: 0;	z-Index: 200;
			}
			.modal-dialog{
   				background-color: white;
   				width: 75% !important;
			}

			.modal-header{
   				background-color: rgb(224, 236, 247);
			}
			.modal-footer{
  				clear:both;
			}
			.dg .c input[type=text] {                                                    
				line-height:normal;                                                                  
			} 
			.dg .c div {
				box-sizing: content-box;                                                             
			}
			.dg li.title {
				color:red;
			}
			.center {
				display: block;
				margin-left: auto;
				margin-right: auto;
			}	
			.divMapa {
				float:left;
				border:1px solid #FFFFFF;
				width:400px;
			}	
		</style>
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
		integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
		crossorigin=""/>
		<!-- Make sure you put this AFTER Leaflet's CSS -->
		<script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
		integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
		crossorigin=""></script>
	</head>
	<body>		
		
		<div id="container">
			<div id="dat"></div>
			<div id="content">
			</div>
			<div id="content2">
			</div>
		</div>

		<div id="finestraInfo" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" width='90%' style="visibility: hidden">
			<div class="modal-dialog">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
					<h3 id="modalHeader">Informació dels sensors disponibles</h3>
				</div>
				<div class="modal-body" id="missatge">
					<iframe src="https://docs.google.com/spreadsheets/d/1Ba-fxzhfwNNLMs_uMRLbJCzAuFO2ReOXzoOytcYsUOw/edit#gid=1727080996" height="600" width="50%"></iframe>           	
				</div>
				<div class="modal-footer">
					<button class="btn" data-dismiss="modal" aria-hidden="true">Tancar</button>
				</div>
			</div>
		</div> 

		<div id="finestraExploracio" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" width='90%' style="visibility: hidden">
			<div class="modal-dialog">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
					<h3 id="headerExploracio"></h3>
				</div>
				<div class="modal-body" id="missatgeExploracio">						
					<div id="mapa1" class="divMapa"></div>	
					<div id="mapa2" class="divMapa"></div>
					<div id="mapa3" class="divMapa"></div>	
					<div id="mapa4" class="divMapa"></div>	
					<div id="mapa5" class="divMapa"></div>					
				</div>
				<div class="modal-footer">
					<button class="btn" data-dismiss="modal" aria-hidden="true">Tancar</button>
				</div>
			</div>
		</div> 

		<script src="https://code.jquery.com/jquery-1.12.4.js"></script>     

		<!-- Bootstrap -->
		<!-- Latest compiled and minified CSS -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"> 

		<!-- Optional theme -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous"> 

		<!-- Latest compiled and minified JavaScript -->
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script> 

		<script src="../three.js/build/three.min.js"></script>
		<script src="../three.js/examples/js/renderers/Projector.js"></script>
		<script src="../three.js/examples/js/renderers/CanvasRenderer.js"></script>
		<script src="../three.js/examples/js/libs/dat.gui.min.js"></script>
		<script src="../three.js/examples/js/controls/OrbitControls.js"></script>
		<script src="../three.js/examples/js/loaders/OBJLoader.js"></script>
		<script src="../three.js/examples/js/Detector.js"></script>

		<script src="pixi.min.js"></script>

		<script>
			var container,  container2, content, content2, camera, camera2D, scene, renderer;
			var meshTerra, llegenda, discs, bateria, orbita, tauler, mapa2D;
			var omegaSat, periodeSat, aOrbita, bOrbita, eOrbita, pOrbita;
			var angleInclinacio;
			var vEsferic;
			var geometrySat, geometryLink3D, materialLink3D, materialOrbita, geometryEstacio, geometryEstacio3D, materialEstacio3D;
			var textPeriode;
            var grupMon;
			var folder1,folder4;
			var quaternionTerra;
			var estacio3D=[];
			var link2D=[];
			var link3D=[];
			var posLink3D=[];
			var proximitat=[];
			var zonaProx=[];
            var maxSat=1;
			var maxOrb=1;
            var sat3D=[];
			var grupSat=[];
			var angleEscombrat=[];
			var app;
			var puntSat=[];
			var puntEstacio=[];
			var puntZona=[];
			var tros=[];
			var appExploracio;
			var mapa=[];
			var capa=[];
			var sensor=[];
			var sensorsIniciats=false;
			var numSensors=0;

			// CONSTANTS TERRA            
            const MU=398694790080000; // G * massa de la Terra, S.I.
			const rTerra=6458428; // radi de l'esfera terrestre, metres
			const segonsDia=23*3600+56*60+4; // nombre de segons que té un dia
			const omega=2*Math.PI/segonsDia; // freqüencia angular de rotació de la Terra entorn al seu eix, rad/s
            const angleTerra=0 //23.4369*Math.PI/180; // angle d'inclinació de l'eix terrestre, rad
			const omegaSol=omega/365.256363; // freqüencia angular de translació de la Terra entorn al Sol, rad/s

			// CONSTANTS SIMULACIÓ
			const maxPointsGraph = 8192; // màxim de punts en les gràfiques
			const shiftCount=1;	// al cap de quants renderings s'agafa un punt de la trajectòria
			const midaSatelit=0.04; // escala d'ampliació del OBJ del satèl·lit
			const stepAngle=1; // al cap de quants graus es considera un nou punt en la zona de proximitat
			const ample = 0.5;
			const ampleRight = 0.5;
			const radiPunt=4;
			const midaMapa=256;
			const midaQuadre=16;

			// CONSTANTS DESPESA DISC I BATERIA
			const ritmeDiscTransfer=0.02;

			//const ritmeBateriaDiscs=0;//-0.05;
			const ritmeBateriaTransfer=-0.01;
			const ritmeBateriaPanell=0.01;

            // VARIABLES DE SIMULACIÓ	
			var ambWebgl; // el navegador suporta WebGL			
            var temps, previousTime, interval; // en segons
			var count; // comptador de punts en la trajectòria
			var countGraph; // comptador de punts en les gràfiques
			var steps; // comptador de renderings
			var enPausa = true; // animació
			var dintre = []; // dins de la zona de proximitat
			var dintreZona = []; // dins de la zona d'estudi
			var ambLlum = true; // fora de la zona d'ombra
			var maxCountGraph; // nombre de punts necessaris en les gràfiques per representar un dia sencer
			var diaSencer; // ha transcorregut més d'un dia sencer (boolean)
			var nivellDiscs; // espai d'emmagatzematge de dades sense ocupar (%)
			var nivellBateria; // nivell de càrrega de les bateries (%)
			var vectorLlum; // vector amb origen al Sol i final a la Terra (unitari)
			var longitudAnterior; // en el traçat de la trajectòria, longitud del satèl·lit 2D en l'anterior rendering
			var dragging=false; // arrossegant un element del mapa
			var dragEstacio; // arrossegant una estació de seguiment (i no una zona d'estudi)
			var angleLatEstacio=[]; // array de latituds de les estacions
			var angleLonEstacio=[]; // array de longituds de les estacions
			angleLatEstacio[0]=41*Math.PI/180; // latitud inicial de l'estació per defecte
			angleLonEstacio[0]=2*Math.PI/180; // longitud inicial de l'estació per defecte
			var angleLatZona=[]; // array de latituds de les zones d'estudi
			var angleLonZona=[]; // array de longituds de les zones d'estudi
			angleLatZona[0]=-50*Math.PI/180; // latitud inicial de la zona d'estudi per defecte
			angleLonZona[0]=-90*Math.PI/180; // longitud inicial de la zona d'estudi per defecte
			var numEstacions=1; // nombre actual d'estacions
			var numZones=1; // nombre actual de zones d'estudi
			var satMin=1; // distància mínima entre el centre de la Terra i el Satèl·lit (en referència a 1, radi de la Terra)
			var botoIniciar;
			var estil;
			var origenX, finalX, origenY, finalY;
			var app;
			var ritmeDisc = 0;
			var ritmeBateria = 0;
			var centreMapaX = midaMapa; //window.innerWidth * ampleRight / 2;
			var centreMapaY = 600; //window.innerHeight/ 2 + midaMapa;

			// SENSORS
			var row_sen=[];
			var potSensors=0;
			var disSensors=0;	
			var totalPot=0;
			var totalDis=0;

			function initGUI() {
				var menuDiv = document.getElementById( 'dat' );
				var gui = new dat.GUI({autoPlace: false, width:350});
				menuDiv.appendChild( gui.domElement );
				folder1 = gui.addFolder( 'ÒRBITA DEL SATÈL·LIT' );
				folder1.add( parametres, "longitud", 0, 360, 1 ).name("Longitud node asc.").onChange( canviaParametres );
				folder1.add( parametres, "inclinacio", 0, 180, 1 ).name("Inclinació").onChange( canviaParametres );
				folder1.add( parametres, "argPerigeu", 0, 360, 1 ).name("Arg. del perigeu").onChange( canviaParametres );
				folder1.add( parametres, "aOrbita", satMin*rTerra/1000, 50000, 100 ).name("Semieix major").onChange( canviaSemieix );
				folder1.add( parametres, "excentricitat", 0, 1-satMin*rTerra/parametres.aOrbita/1000, 0.01 ).name("Excentricitat").onChange( canviaExcentricitat );
				//folder1.add( parametres, "nSat", 1, maxSat, 1 ).name("Satèl·lits en òrbita").onChange( canviaNombre );
				//folder1.add( parametres, "nOrb", 1, maxSat, 1 ).name("Quantitat d'òrbites").onChange( canviaNombre );
                folder1.add( parametres, "anomalia", 0, 360, 1 ).name("Anomalia veritable").onChange( canviaAnomalia );
				textPeriode=folder1.add( parametres, "display");
				textPeriode.name("PERÍODE :");
				textPeriode.domElement.hidden = true;
				var estilPeriode = textPeriode.domElement.previousSibling.style;
				estilPeriode.textAlign = 'center';
				estilPeriode.width= '100%';
				var folder2 = gui.addFolder( 'ESTACIONS DE SEGUIMENT' );
                folder2.add( parametres, "radiProximitat", 100, 4000, 100 ).name("Radi de proximitat").onChange( canviaRadiProximitat );
				folder2.add( parametres, "afegirEstacio").name("Afegir estació");
				folder2.add( parametres, "eliminarEstacio").name("Eliminar estació");
				var folder6 = gui.addFolder( 'ZONES D\'ESTUDI' );
                folder6.add( parametres, "radiZona", 100, 8000, 100 ).name("Radi de les zones").onChange( canviaRadiZona );
				folder6.add( parametres, "afegirZona").name("Afegir zona");
				folder6.add( parametres, "eliminarZona").name("Eliminar zona");				
				//var folder7 = gui.addFolder( 'SIMULADOR' );				
				//folder7.add( parametres, "infoParametres").name("Paràmetres");	
				//folder7.open();
				//*/
				var folder3 = gui.addFolder( 'SIMULACIÓ' );	
				folder3.add( parametres, "infoParametres").name("Paràmetres");			
				//folder3.add( parametres, "mapa", [ 'mapa_simple.png','mapa_fisic.png', 'mapa_politic.png','mapa_gel.png' ]).name("Tipus de mapa").onChange( canviaMapa );
				folder3.add( parametres, "velAnimacio",1,10,1).name("Velocitat d'animació").onChange( canviaParametres );
				botoIniciar = folder3.add( parametres, "pausa");
				botoIniciar.name("I N I C I A");
				estil = botoIniciar.domElement.previousSibling.style;
				estil.backgroundColor = 'green';
				estil.textAlign = 'center';
				estil.width= '100%';
				//folder1.open();
                //folder2.open();
				//folder6.open();
				folder3.open();
				
				var guiDret = new dat.GUI({width:300});
				folder4 = guiDret.addFolder( 'EQUIPAMENT DEL SATÈL·LIT' );
				folder4.add( parametres, "panells", 1, 5, 1 ).name("Panells solars");
				folder4.add( parametres, "discs", 1, 5, 1 ).name("Unitats de disc");
				folder4.add( parametres, "infoSensors").name("Sensors");
				//folder4.add( parametres, "cameres", 0, 5, 1 ).name("Càmeres òptiques");
				//folder4.add( parametres, "radars", 0, 5, 1 ).name("Sistemes de radar");
				folder4.open();
				var folder5 = guiDret.addFolder( 'INFORMACIÓ ADDICIONAL' );
				//folder5.add( parametres, "infoSatelit").name("Satèl·lit");		
				folder5.add( parametres, "infoMissions").name("Missions");						
				folder5.add( parametres, "selMissio").name("Assignació de missió");					
				//folder5.open();			
			}

			init();
			function init() {
				// PARÀMETRES DE SIMULACIÓ
				parametres = {
					longitud: 0, // de l'òrbita del satèl·lit, graus
					inclinacio: 45, // de l'òrbita del satèl·lit, graus
					argPerigeu: 0, // argument del perigeu, graus
					aOrbita: 10000, // semieix major de l'òrbita el·líptica, km
					excentricitat: 0, // excentricitat de l'òrbita (entre 0 i 1)
					anomalia:0, // anomalia veritable, graus
                    nSat:1, // quantitat de satèl·lits a l'òrbita
					nOrb:1, // quantitat d'òrbites
                    radiProximitat: 3000, // radi de la zona de proximitat a l'estació, km
					radiZona: 5000, // radi de la zona d'estudi, km
					afegirEstacio: botoAfegirEstacio,
					eliminarEstacio: botoEliminarEstacio,
					afegirZona: botoAfegirZona,
					eliminarZona: botoEliminarZona,
					mapa2D: 'mapa_fisic_silueta.png', // fitxer de textura del mapa
					mapa3D: 'mapa_fisic.png', // fitxer de textura del mapa
					velAnimacio: 3, // velocitat de l'animació
					display : true, // visualitzador del període del satèl·lit. El valor booleà no té cap efecte
					pausa: botoPausa, // botó per pausar o reprendre la simulació
					//infoSatelit: botoInfoSatelit, // finestra modal amb el satèl·lit 3D
					infoSensors: botoInfoSensors, // finestra modal amb informació sobre els sensors
					infoMissions: botoInfoMissions, // finestra modal amb informació sobre els sensors					
					selMissio: botoSelMissio, //selecciona una missió
					infoParametres: botoInfoParametres, //Presenta la inforació dels paràmetres configurables del simulador
					panells: 1, 
					discs:1,
					cameres: 1,
					radars: 1
				};

				container = document.getElementById( 'content' );
				container2 = document.getElementById( 'content2' );
                // CÀMERA
				camera = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 1, 1000 );
				camera.up.set(0,0,1);
				camera.position.x = 4; // red
				camera.position.y = 0; // green
				camera.position.z = 0; // blue

				scene = new THREE.Scene();
				scene.background = new THREE.Color( 0x131313 );

                // LLUM
                var ambientLight = new THREE.AmbientLight( 0x444444 ); // 10%
                scene.add(ambientLight);

                var directionalLight = new THREE.DirectionalLight( 0xffffff, 1);
				
                vectorLlum=new THREE.Vector3(-1,0,0);
				directionalLight.position.set(-vectorLlum.x, -vectorLlum.y, -vectorLlum.z);
				directionalLight.castShadow=true;
                scene.add( directionalLight );     

                // EIX TERRA
                var dir = new THREE.Vector3(0,Math.sin(angleTerra),Math.cos(angleTerra));
                var origin = new THREE.Vector3( 0, 0, 0 );
                var arrowHelper = new THREE.ArrowHelper( dir, origin, 1.1, 0x555555, 0.075, 0.05);
                scene.add( arrowHelper );

				// TERRA I MAPA 2D
				canviaMapa();

				// SATÈL·LIT 3D
				grupMon=new THREE.Group();
				var manager = new THREE.LoadingManager();
				manager.onProgress = function ( item, loaded, total ) {					
					for(s=0;s<maxOrb;s++) {
						grupSat[s]=new THREE.Group();
						grupMon.add(grupSat[s]);
					}
					canviaParametres();
					animate();
				};
				var onProgress = function ( xhr ) {
					if ( xhr.lengthComputable ) {
						var percentComplete = xhr.loaded / xhr.total * 100;
					}
				};
				var onError = function ( xhr ) {
				};
				var loader = new THREE.OBJLoader( manager );
				loader.load( 'imatges/sat.obj', function ( object ) {
					object.traverse( function ( child ) {
						if ( child instanceof THREE.Mesh ) {
							child.material=new THREE.MeshStandardMaterial( { color: 0x565758, overdraw: true} );
                            child.receiveShadow = true;
						}
					} );
					object.scale.set(midaSatelit,midaSatelit,midaSatelit);
					for(s=0;s<maxOrb;s++) {
						sat3D[s]=[];
						for(i=0;i<maxSat;i++) {							
							sat3D[s][i]=object.clone();
						}
					}					
				}, onProgress, onError );				
			
				// ÒRBITA
				materialOrbita = new THREE.LineBasicMaterial( { color : 0xffffff } );
				var geometryOrbita = new THREE.BufferGeometry();
				orbita = new THREE.Line( geometryOrbita, materialOrbita );

				// LINK 3D
				/*materialLink3D = new THREE.LineBasicMaterial({ color: 0xffffff, linewidth: 1 });
				
				for(i=0;i<maxSat;i++) {
					posLink3D[i]=[];
					posLink3D[i][0] = new Float32Array(2 * 3);
					geometryLink3D = new THREE.BufferGeometry();
					geometryLink3D.addAttribute('position', new THREE.BufferAttribute(posLink3D[i][0], 3));
					link3D[i]=[];
					link3D[i][0] = new THREE.Line(geometryLink3D, materialLink3D);
					scene.add(link3D[i][0]);
					link3D[i][0].geometry.attributes.position.needsUpdate = true;
				}*/


				// ESTACIÓ 3D
				materialEstacio3D = new THREE.MeshBasicMaterial( { color: 0xff0000} );
				geometryEstacio3D = new THREE.SphereGeometry( 0.02, 6, 6 );
				estacio3D[0] = new THREE.Mesh( geometryEstacio3D, materialEstacio3D );

				// MÓN
                grupMon.setRotationFromAxisAngle(new THREE.Vector3(1,0,0),-angleTerra);
                scene.add(grupMon);
			
				// RENDERER
				if (Detector.webgl) {
					ambWebgl=true;
					renderer = new THREE.WebGLRenderer();
					renderer.shadowMap.enabled = true;
					renderer.shadowMap.type = THREE.PCFSoftShadowMap;
				} else {
					ambWebgl=false;
					renderer = new THREE.CanvasRenderer();
					console.log("WebGL no és compatible, renderitzant amb CanvasRenderer.");
					alert("Aquest navegador no és compatible amb WebGL,\nalgunes funcionalitats del simulador no estaran disponibles.");
				}
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth * ample, window.innerHeight );
				container.appendChild( renderer.domElement );
				app = new PIXI.Application({width: window.innerWidth * ampleRight, height: window.innerHeight});
				app.renderer.backgroundColor = 0x131313;
				container2.appendChild(app.view);	

				centreMapaX = window.innerWidth * ampleRight / 2;
				centreMapaY = window.innerHeight/ 2 + midaMapa-20;

				origenX=centreMapaX-240;
				finalX=centreMapaX+240;
				origenY=centreMapaY-260-midaMapa;
				finalY=centreMapaY+90-midaMapa;

				PIXI.loader
					.add("imatges/mapa_fisic.png")
					.add("imatges/mapa_fisic_silueta.png")
					.add("imatges/sat_punt.png")
					.add("imatges/estacio_punt.png")
					.add("imatges/zona_punt.png")
					.add("imatges/eixos2DNou.png")
					.add("imatges/llegenda2D.png")
					.add("imatges/8k_earth_daymap.jpg")
					.load(setup);
					function setup() {
						var silueta = new PIXI.Sprite(PIXI.loader.resources["imatges/mapa_fisic_silueta.png"].texture);
						silueta.x=centreMapaX-midaMapa;
						silueta.y=centreMapaY-midaMapa/2;
						app.stage.addChild(silueta);

						// TAULER DE GRÀFIQUES	

						var tauler = new PIXI.Sprite(PIXI.loader.resources["imatges/eixos2DNou.png"].texture);
						tauler.x = centreMapaX-257;
						tauler.y = centreMapaY-midaMapa-280;
						app.stage.addChild(tauler);

						var llegenda = new PIXI.Sprite(PIXI.loader.resources["imatges/llegenda2D.png"].texture);
						llegenda.x = centreMapaX-258;
						llegenda.y = centreMapaY-midaMapa-340;
						app.stage.addChild(llegenda);
				
						baseTx=PIXI.loader.resources["imatges/mapa_fisic.png"].texture;
						for(i=0;i<midaQuadre*2;i++){
							tros[i]=[];
							for(j=0;j<midaQuadre;j++) {
								var rectangle = new PIXI.Rectangle(i*midaQuadre, j*midaQuadre, midaQuadre, midaQuadre);
								texture = new PIXI.Texture(baseTx, rectangle);
								tros[i][j]= new PIXI.Sprite(texture);
								tros[i][j].x=centreMapaX - midaMapa + i * midaQuadre;
								tros[i][j].y=centreMapaY - midaMapa/2 + j * midaQuadre;
								tros[i][j].visible=false;
								tros[i][j].interactive = true;
								tros[i][j].buttonMode = true;
								tros[i][j].on('pointerdown', function(e) {
												var i=(this.position.x+midaMapa-centreMapaX)/midaQuadre;
												var j=midaQuadre+(this.position.y-midaMapa/2-centreMapaY)/midaQuadre;
												mostraTros(i,j);
											});
								app.stage.addChild(tros[i][j]);
							}
						}

						baseHD=PIXI.loader.resources["imatges/8k_earth_daymap.jpg"].texture;	

						puntEstacio[0]=new PIXI.Sprite(PIXI.loader.resources["imatges/estacio_punt.png"].texture);
						puntEstacio[0].index=0;
						puntEstacio[0].interactive = true;
						puntEstacio[0].buttonMode = true;
						puntEstacio[0].on('pointerdown', onDragStartEst);
						puntEstacio[0].on('pointermove', onDragMove);
						puntEstacio[0].on('pointerup', onDragEndEst);
						app.stage.addChild(puntEstacio[0]);

						puntZona[0]=new PIXI.Sprite(PIXI.loader.resources["imatges/zona_punt.png"].texture);
						puntZona[0].index=0;
						puntZona[0].interactive = true;
						puntZona[0].buttonMode = true;
						puntZona[0].on('pointerdown', onDragStartZona);
						puntZona[0].on('pointermove', onDragMove);
						puntZona[0].on('pointerup', onDragEndZona);
						app.stage.addChild(puntZona[0]);

						mouEstacio(0);
						mouZona(0);

						for(i=0;i<maxSat;i++) {
				    		puntSat[i] = new PIXI.Sprite(PIXI.loader.resources["imatges/sat_punt.png"].texture);
							app.stage.addChild(puntSat[i]);
                		}

						// UNITATS DE DISC I BATERIA
						discs =	new PIXI.Graphics();
						bateria = new PIXI.Graphics();
				}	
		
				WIDTH=window.innerWidth * ampleRight;
				HEIGHT=window.innerHeight;
				
				var ratio = Math.min(WIDTH/(2*midaMapa), HEIGHT/(3.5*midaMapa));
				app.stage.position.set(WIDTH/2, HEIGHT/2);
				app.stage.scale.set(ratio, ratio);
				app.stage.pivot.set(WIDTH/2, HEIGHT/2);
										
				controls = new THREE.OrbitControls( camera, renderer.domElement );
				window.addEventListener( 'resize', onWindowResize, false );
				window.addEventListener( 'focus', onFocus, false );

				for(k=1;k<6;k++) {
					//mapa[k] = L.map('mapa'+k,{zoomControl:false,scrollWheelZoom:false,dragging:false});
					mapa[k] = L.map('mapa'+k,{scrollWheelZoom:false,dragging:false});
				}	
				initGUI();
			}

			function mostraTros(i,j) {
				/*if(appExploracio==undefined) {
					appExploracio = new PIXI.Application({width: 512, height: 512});
					appExploracio.renderer.backgroundColor = 0x000000;
					contenidor = document.getElementById('missatgeExploracio');
					contenidor.appendChild(appExploracio.view);
				}
				var rectangle = new PIXI.Rectangle(i*4096/32, j*4096/32, 4096/32, 4096/32);
				texture = new PIXI.Texture(baseHD, rectangle);
				exploracio = new PIXI.Sprite(texture);
				exploracio.setTransform(0,0,4,4);
				appExploracio.stage.addChild(exploracio);*/

				$("#finestraExploracio").css({"visibility":"visible"});
				$("#finestraExploracio").modal('show');
				for(k=1;k<6;k++) {
					$("#mapa"+k).css({"height":"400px"});
				}
				
				var latitud=90-180/midaQuadre*j-midaQuadre/2;
				var longitud=-180+360/(midaQuadre*2)*i+midaQuadre/2;
				$("#headerExploracio").html("Exploració de la zona (latitud:"+latitud+"°, longitud:"+longitud+"°)");
		
				for(k=1;k<6;k++) {
					mapa[k].eachLayer(function (layer) {
						mapa[k].removeLayer(layer);
					});
					$("#mapa"+k).hide();
					mapa[k].setView([latitud, longitud], 5);
				}

				var mapesOcupats=0;
				ocupaMapa(1,0,latitud,longitud); // Visible
				mapesOcupats++;
				if (sensor[1]||sensor[3]||sensor[5]) { // SAR, GNSS-R, LIDAR
					mapesOcupats++;
					ocupaMapa(mapesOcupats,1,latitud,longitud);
				}
				if (sensor[2]) { // Radiometer
					mapesOcupats++;
					ocupaMapa(mapesOcupats,2,latitud,longitud);
				}
				if (sensor[4]) { // GNSS-RO
					mapesOcupats++;
					ocupaMapa(mapesOcupats,3,latitud,longitud);
				}
				if (sensor[6]) { // HyperSpectral
					mapesOcupats++;
					ocupaMapa(mapesOcupats,4,latitud,longitud);
				}

				$('#finestraExploracio').on('shown.bs.modal', function(){
					setTimeout(function() {
						for(k=1;k<6;k++) {
							mapa[k].invalidateSize();
						}                  
					}, 2);
				});
			}

			function ocupaMapa(numMapa,sensor,latitud,longitud) {
				switch(sensor) {
				case 0: // Visible
					capa[numMapa] =  L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
						attribution: 'Tiles &copy; Esri_WorldImagery'
					});
					capa[1].addTo(mapa[1]);
					break;
				case 1: // SAR, GNSS-R, LIDAR
					capa[numMapa] = L.tileLayer('https://map1.vis.earthdata.nasa.gov/wmts-webmerc/SRTM_Color_Index/default/{time}/{tilematrixset}{maxZoom}/{z}/{y}/{x}.{format}', {
						attribution: 'GIBS / NASA / SRTM_Color_Index',
						bounds: [[latitud-30, longitud-30], [latitud+30, longitud+30]],
						minZoom: 1,
						maxZoom: 12,
						format: 'png',
						time: '',
						tilematrixset: 'GoogleMapsCompatible_Level'
					});
					capa[numMapa].addTo(mapa[numMapa]);					
					break;
				case 2: // Radiometer
					capa[numMapa] = L.tileLayer('https://map1.vis.earthdata.nasa.gov/wmts-webmerc/SMAP_L4_Soil_Temperature_Layer_1/default/{time}/{tilematrixset}{maxZoom}/{z}/{y}/{x}.{format}', {
						attribution: 'GIBS / NASA / Soil_Temperature',
						bounds: [[latitud-30, longitud-30], [latitud+30, longitud+30]],
						minZoom: 1,
						maxZoom: 6,
						format: 'png',
						time: '',
						tilematrixset: 'GoogleMapsCompatible_Level'
					});
					capa[numMapa].addTo(mapa[numMapa]);
					break;
				case 3 : // GNSS-RO
					capa[numMapa] = L.tileLayer('https://map1.vis.earthdata.nasa.gov/wmts-webmerc/Particulate_Matter_Below_2.5micrometers_2010-2012/default/{time}/{tilematrixset}{maxZoom}/{z}/{y}/{x}.{format}', {
						attribution: 'GIBS / NASA / Particulate_Matter_Below_2.5micrometers',
						bounds: [[latitud-30, longitud-30], [latitud+30, longitud+30]],
						minZoom: 1,
						maxZoom: 7,
						format: 'png',
						time: '',
						tilematrixset: 'GoogleMapsCompatible_Level'
					});
					capa[numMapa].addTo(mapa[numMapa]);
					break;
				case 4 : // HyperSpectral
					capa[numMapa] = L.tileLayer('https://map1.vis.earthdata.nasa.gov/wmts-webmerc/MODIS_Terra_NDVI_8Day/default/{time}/{tilematrixset}{maxZoom}/{z}/{y}/{x}.{format}', {
						attribution: 'GIBS / NASA / MODIS_Terra_NDVI_8Day',
						bounds: [[latitud-30, longitud-30], [latitud+30, longitud+30]],
						minZoom: 1,
						maxZoom: 9,
						format: 'png',
						time: '2018-11-18',
						tilematrixset: 'GoogleMapsCompatible_Level'
					});
					capa[numMapa].addTo(mapa[numMapa]);
					break;
				} 
				$("#mapa"+numMapa).show();
			}

			function onFocus(){
				canviaParametres();
			}

			function onDragStartEst(evt) {
				this.data = evt.data;
    			this.dragging = true;
				proximitat[this.index].clear();
			}

			function onDragMove(evt) {
				if (this.dragging)
				{
					var newPosition = this.data.getLocalPosition(this.parent);
					this.position.x = newPosition.x;
					this.position.y = newPosition.y;
				}
			}

			function onDragEndEst(evt) {
				this.dragging = false;
				angleLatEstacio[this.index]=(-puntEstacio[this.index].position.y+centreMapaY)*Math.PI/midaMapa;
				angleLonEstacio[this.index]=(puntEstacio[this.index].position.x-centreMapaX)*Math.PI/midaMapa;
				mouEstacio(this.index);
				this.data = null;
			}

			function onDragStartZona(evt) {
				this.data = evt.data;
    			this.dragging = true;
				zonaProx[this.index].clear();
			}

			function onDragEndZona(evt) {
				this.dragging = false;
				angleLatZona[this.index]=(-puntZona[this.index].position.y+centreMapaY)*Math.PI/midaMapa;
				angleLonZona[this.index]=(puntZona[this.index].position.x-centreMapaX)*Math.PI/midaMapa;
				mouZona(this.index);
				this.data = null;
			}

			function botoPausa() {		
				enPausa=!enPausa;
				if (!enPausa) {
					estil.backgroundColor = 'IndianRed';
					botoIniciar.name("P A U S A");
					previousTime=new Date().getTime();
					animate();
				} else {
					estil.backgroundColor = 'green';
					botoIniciar.name("C O N T I N U A");
				}
			}

			function addGraph() {
				if(!enPausa) {
					if (temps>segonsDia) {
						if(!diaSencer) {
							finalCountGraph=countGraph;
							diaSencer=true;
						}
					}

					// APORTACIONS I DESPESES DE DISC I BATERIA
					ritmeDisc=0;
					ritmeBateria=0;

					var enregistrant=false;
					var transferint=false;

					if (ambLlum) { // Aportació d'energia solar
						ritmeBateria+=parametres.panells*ritmeBateriaPanell;
					}

					var zonaEstudi=0;
					do { // Despesa única de càmeres i radar quan s'està dins d'alguna de les zones d'estudi
						if (dintreZona[0][zonaEstudi]) {
							ritmeDisc+=-disSensors/100000;
							ritmeBateria+=-potSensors/10000;
							enregistrant=true;
						}
						zonaEstudi++;
					}
					while(!enregistrant && zonaEstudi<numZones)

					for(j=0;j<numEstacions;j++) { // Consum del transfer a totes les estacions properes
						if (dintre[0][j] && disSensors>0) {
							ritmeDisc+=ritmeDiscTransfer;
							ritmeBateria+=ritmeBateriaTransfer;
							transferint=true;
						}
					}

					/*if (transferint || enregistrant) { // Consum energètic dels discs
						ritmeBateria+=parametres.discs*ritmeBateriaDiscs;
					}*/

					nivellDiscs+=parametres.velAnimacio*interval*shiftCount*ritmeDisc/parametres.discs;

					if (nivellDiscs>100) {
						nivellDiscs=100;
					}
					if (nivellDiscs<0) {
						nivellDiscs=0;
					}	

					nivellBateria+=parametres.velAnimacio*interval*shiftCount*ritmeBateria;

					if (nivellBateria>100) {
						nivellBateria=100;
					}
					if (nivellBateria<0) {
						nivellBateria=0;
					}			
						
					// Punts de les gràfiques

					if (diaSencer) {
						posDiscs[finalCountGraph * 2 + 0] = finalX;
						posDiscs[finalCountGraph * 2 + 1] = origenY+(finalY-origenY)/100*(100-nivellDiscs);
						posBateria[finalCountGraph * 2 + 0] = finalX;
						posBateria[finalCountGraph * 2 + 1] = origenY+(finalY-origenY)/100*(100-nivellBateria);
						for(i=0;i<finalCountGraph;i++){							
							posDiscs[i* 2 + 1] = posDiscs[i* 2 + 3];
							posBateria[i* 2 + 1] = posBateria[i* 2 + 3];
						}
					} else {
						posDiscs[countGraph * 2 + 0] = origenX+temps*(finalX-origenX)/segonsDia;
						posDiscs[countGraph * 2 + 1] = origenY+(finalY-origenY)/100*(100-nivellDiscs);
						posBateria[countGraph * 2 + 0] = origenX+temps*(finalX-origenX)/segonsDia;
						posBateria[countGraph * 2 + 1] = origenY+(finalY-origenY)/100*(100-nivellBateria);		
						countGraph++;
					}
					discs.clear();
					discs.position.set(0,0);	
			        discs.lineStyle(3, 0x0000FF);
					discs.moveTo(origenX,origenY);
					app.stage.addChild(discs);
					bateria.clear();
					bateria.position.set(0,0);	
			        bateria.lineStyle(3, 0x00FF00);
					bateria.moveTo(origenX,origenY+(finalY-origenY)/2);
					app.stage.addChild(bateria);
					for(i=0;i<countGraph;i++) {
						discs.lineTo(posDiscs[i * 2 + 0],posDiscs[i * 2 + 1]);
						bateria.lineTo(posBateria[i * 2 + 0],posBateria[i * 2 + 1]);
					}
				}								
			}

			function addPoint(){
				if(!enPausa) {				
                    for(i=0;i<maxSat;i++) {
                        var laLatitud=(centreMapaY-puntSat[i].y-radiPunt)/midaMapa*Math.PI;
                        var laLongitud=(puntSat[i].x-centreMapaX+radiPunt)/midaMapa*Math.PI;

                        var distanciaActual=0;
                        dintre[i]=[];
                        for(j=0;j<numEstacions;j++) {
                            distanciaActual=distancia(angleLatEstacio[j],laLatitud,angleLonEstacio[j],laLongitud);
                            if (distanciaActual<parametres.radiProximitat*1000) {
                                dintre[i][j]=true;
                            }
                            else {
                                dintre[i][j]=false;
                            }
                        }                    

                        dintreZona[i]=[];
                        for(j=0;j<numZones;j++) {
                            distanciaActual=distancia(angleLatZona[j],laLatitud,angleLonZona[j],laLongitud);
                            if (distanciaActual<parametres.radiZona*1000) {
                                dintreZona[i][j]=true;
								var numTrosX=Math.floor(((puntSat[0].x + radiPunt - centreMapaX) + midaMapa) / midaQuadre);
								var numTrosY=Math.floor(((puntSat[0].y + radiPunt - centreMapaY) + midaMapa/2) / midaQuadre);
								if (tros[numTrosX][numTrosY].visible==false && nivellBateria>0 && nivellDiscs>0) {
									tros[numTrosX][numTrosY].visible=true;
								}
                            }
                            else {
                                dintreZona[i][j]=false;
                            }
                        }
                    }

					var vectorSat3D=new THREE.Vector3();
					sat3D[0][0].getWorldPosition(vectorSat3D);
					var vectorSatUnitari=new THREE.Vector3().copy(vectorSat3D).multiplyScalar(1/vectorSat3D.length());
					
					ambLlum=true;
					var cosinus=vectorSatUnitari.dot(vectorLlum)
					var radiLlum=vectorSat3D.length()*Math.sin(Math.acos(cosinus));
					if (cosinus>0 && radiLlum<1) {
						ambLlum=false;
					}
				}
			}

			function addLink() {
				for(s=0;s<parametres.nOrb;s++) {
					for(i=0;i<parametres.nSat;i++) {
						var worldSat3D=new THREE.Vector3();
						sat3D[s][i].getWorldPosition(worldSat3D);
						for(j=0;j<numEstacions;j++) {
							if (link2D[i][j]!=null) {
								link2D[i][j].clear();
								link2D[i][j].position.set(0,0);	
								link2D[i][j].lineStyle(1, 0xFF0000);
								link2D[i][j].moveTo(puntEstacio[j].x+radiPunt,puntEstacio[j].y+radiPunt);
								app.stage.addChild(link2D[i][j]);

								var worldEstacio3D=new THREE.Vector3();
								estacio3D[j].getWorldPosition(worldEstacio3D);

								if (dintre[i][j]) {
									link2D[i][j].lineTo(puntSat[i].x+radiPunt,puntSat[i].y+radiPunt);
									/*posLink3D[i][j][0]=worldEstacio3D.x;
									posLink3D[i][j][1]=worldEstacio3D.y;
									posLink3D[i][j][2]=worldEstacio3D.z;
									posLink3D[i][j][3]=worldSat3D.x;
									posLink3D[i][j][4]=worldSat3D.y;
									posLink3D[i][j][5]=worldSat3D.z;*/
								}
								/*else {
									for(k=0;k<6;k++) {
										posLink3D[i][j][k]=0;
									}
								}
								if (link3D[i][j]!=undefined) {
									link3D[i][j].geometry.attributes.position.needsUpdate = true;
								}*/
							}
						}
					}
				}
			}			

			function canviaSemieix() {
				var eMax=1-satMin*rTerra/(parametres.aOrbita*1000);
				folder1.__controllers[4].max(eMax);
				canviaParametres();
			}

			function canviaExcentricitat() {
				var aMin=satMin*rTerra/(1-parametres.excentricitat)/1000;
				folder1.__controllers[3].min(aMin);
				canviaParametres();
			}

			function canviaAnomalia() {
				for(i=0;i<parametres.nSat;i++) {
                    for(j=0;j<numEstacions;j++) {
						link2D[i][j].clear();
                    }
                }
				canviaParametres();
			}

			function canviaParametres() {
				var angleInclinacio = parametres.inclinacio * Math.PI/180;
				var angleLongitud = (parametres.longitud + 90 ) * Math.PI/180;
				var anglePerigeu = (parametres.argPerigeu -90) * Math.PI/180;

				longitudAnterior=angleLongitud;

				var quaternionPerigeu=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,0,1),anglePerigeu);
				var quaternionInclinacio=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0), -angleInclinacio);
				var quaternionLongitud=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,0,1), angleLongitud);
				quaternionTerra=new THREE.Quaternion().multiplyQuaternions(quaternionLongitud,new THREE.Quaternion().multiplyQuaternions(quaternionInclinacio,quaternionPerigeu));

				eOrbita=parametres.excentricitat;				

				aOrbita=parametres.aOrbita*1000;
				pOrbita=aOrbita*(1-eOrbita);
				bOrbita=aOrbita*Math.sqrt(1-eOrbita*eOrbita);
				periodeSat=2*Math.PI*Math.sqrt(aOrbita**3/MU);
				omegaSat=2*Math.PI/periodeSat;

				var hores=Math.floor(periodeSat/3600);
				var minuts=Math.floor((periodeSat - 3600 * hores)/60);
				var segons=Math.floor(periodeSat-hores*3600-minuts*60 );
				var stringPeriode="PERÍODE : "+ hores + " hores " + minuts + " minuts " + segons + " segons";
				if (textPeriode!=null) {
					textPeriode.name(stringPeriode);
				}				

			// SAT 2D, 3D
				var mida=0.02*pOrbita/rTerra;
				for(s=0;s<parametres.nOrb;s++) {
					for(i=0;i<maxSat;i++) {
						grupSat[s].remove(sat3D[s][i]);
						//link3D[i]=[];
					}
				}	
				for(s=0;s<parametres.nOrb;s++) {
					for(i=0;i<parametres.nSat;i++) {
						grupSat[s].add(sat3D[s][i]);
						sat3D[s][i].scale.set(mida,mida,mida);
					}
				}				

			// ÒRBITA
				grupMon.remove(orbita);
				var curve = new THREE.EllipseCurve((pOrbita-aOrbita)/rTerra,0,aOrbita/rTerra,bOrbita/rTerra,0,2*Math.PI,false,0);
				var points = curve.getPoints(360);
				var geometryOrbita = new THREE.BufferGeometry().setFromPoints(points);
				orbita = new THREE.Line( geometryOrbita, materialOrbita );
				orbita.quaternion.copy(quaternionTerra);
				grupMon.add(orbita);
				
			// LINK 3D (satèl·lit i, estació j)
                /*for(i=0;i<maxSat;i++) {
					for(j=0;j<numEstacions;j++) {
						scene.remove(link3D[i][j]);
                    }					
				}*/
				
				/*for(i=0;i<parametres.nSat;i++) {
                    posLink3D[i]=[];
                    for(j=0;j<numEstacions;j++) {
                        geometryLink3D = new THREE.BufferGeometry();
                        posLink3D[i][j] = new Float32Array(2 * 3);
                        geometryLink3D.addAttribute('position', new THREE.BufferAttribute(posLink3D[i][j], 3));
                        link3D[i][j] = new THREE.Line(geometryLink3D, materialLink3D);
                        scene.add(link3D[i][j]);
                    }
                }*/

			// DISCS
				posDiscs = new Float32Array(maxPointsGraph * 2);

			// BATERIA
				posBateria = new Float32Array(maxPointsGraph * 2);

			// LINK 2D
				for(i=0;i<parametres.nSat;i++) {
					link2D[i]=[];
                    for(j=0;j<numEstacions;j++) {
						link2D[i][j]=new PIXI.Graphics();
                    }
                }
		
			// REININCI SIMULACIÓ
				previousTime=new Date().getTime();
				temps=0;
				diaSencer=false;
				count=0;
				countGraph=0;
				steps=0;
				nivellDiscs=100;
				nivellBateria=50;
				for(s=0;s<parametres.nOrb;s++) {
					for(i=0;i<parametres.nSat;i++) {
						angleEscombrat[i]=Math.PI/180*(parametres.anomalia) + 2* Math.PI / parametres.nSat * i;
					}
				}
				for(i=0;i<32;i++) {
					for(j=0;j<midaQuadre;j++) {
						if (tros[i]!=undefined) {
							tros[i][j].visible=false;
						}
					}
				}
			}

			function onWindowResize() {				
				camera.aspect = window.innerWidth * ample / window.innerHeight;
				camera.updateProjectionMatrix();
				renderer.setSize( window.innerWidth * ample, window.innerHeight );

				WIDTH = window.innerWidth * ampleRight;
				HEIGHT = window.innerHeight;
			
				var ratio = Math.min(WIDTH/(2*midaMapa), HEIGHT/(3.5*midaMapa));
				app.stage.position.set(WIDTH/2, HEIGHT/2);
				app.stage.scale.set(ratio, ratio);
				app.stage.pivot.set(WIDTH/2, HEIGHT/2);
				app.renderer.resize(WIDTH,HEIGHT);
			}

			function animate() {
				requestAnimationFrame( animate );
				render();
			}
			
			function render() {
				if (!enPausa) {
					var currentTime = new Date().getTime();
					interval= currentTime - previousTime;
					temps+=parametres.velAnimacio * interval;
					previousTime = currentTime;	
				}

				if(meshTerra!=null) {
					var quaternionZ=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,0,1), omega*temps);
					meshTerra.quaternion.copy(quaternionZ);
				}

				for (s=0;s<parametres.nOrb;s++) {
					for (i=0;i<parametres.nSat;i++) {
						if (!enPausa) {
							angleEscombrat[i]+=Math.sqrt(MU/((aOrbita*(1-eOrbita**2))**3))*(1+eOrbita*Math.cos(angleEscombrat[i]))**2*parametres.velAnimacio*interval;
						}

						var quaternion=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,0,1),Math.PI + angleEscombrat[i]);
						sat3D[s][i].quaternion.copy(quaternion);
						
						var radi=pOrbita/rTerra*(1+eOrbita)/(1+eOrbita*Math.cos(angleEscombrat[i]));
						sat3D[s][i].position.x=radi*Math.cos(angleEscombrat[i]);
						sat3D[s][i].position.y=radi*Math.sin(angleEscombrat[i]);

						var vectorSatTerra=new THREE.Vector3(sat3D[s][i].position.x,sat3D[s][i].position.y,0);
						vectorSatTerra.applyQuaternion(quaternionTerra);
						vEsferic=coordEsferiques(vectorSatTerra);              										

						var voltes=Math.floor((vEsferic.z - omega * temps + Math.PI) / (2 * Math.PI));
						var longitudMapa=vEsferic.z -omega * temps - voltes * 2 * Math.PI;                  

						longitudAnterior=longitudMapa;	
						if (puntSat[i]!=undefined) {
							puntSat[i].x=centreMapaX+longitudMapa*midaMapa/Math.PI-radiPunt;
							puntSat[i].y=centreMapaY-(Math.PI/2-vEsferic.y)*midaMapa/Math.PI-radiPunt;
						}
					}
					grupSat[s].quaternion.copy(quaternionTerra);
				}               

				steps++;
				if (temps>0) {
					if (steps % shiftCount == 0) {
						addPoint();	
						addLink();
						addGraph();					
					}
  				} 

				camera.aspect=window.innerWidth * ample / window.innerHeight ;
				camera.updateProjectionMatrix();
                renderer.render( scene, camera );
			}
		
			function coordEsferiques(vector) {
				var r=vector.length();
				var theta=Math.acos(vector.z/r);
				var phi=Math.atan2(vector.y,vector.x);
				return(new THREE.Vector3(r,theta,phi));
			}

			function canviaMapa() {
				var loader3 = new THREE.TextureLoader();
				loader3.load( 'imatges/'+parametres.mapa3D, function (texture) {
                    // TERRA
					grupMon.remove( meshTerra );
					var geometryTerra = new THREE.SphereGeometry( 1, 20, 20 );
					geometryTerra.rotateX(Math.PI/2);
					var materialTerra = new THREE.MeshLambertMaterial({ map: texture, overdraw: true });
					meshTerra = new THREE.Mesh( geometryTerra, materialTerra );
                    meshTerra.castShadow=true;
					grupMon.add( meshTerra );
					for(j=0;j<numEstacions;j++) {
						meshTerra.add(estacio3D[j]);
					}
				} );	
			}

			function canviaSatelit() {
                var manager = new THREE.LoadingManager();
				manager.onProgress = function ( item, loaded, total ) {
					for(s=0;s<maxOrb;s++) {
						for(i=0;i<maxSat;i++) {
							grupSat[s].add(sat3D[s][i]);	
						}
					}
				};
				var onProgress = function ( xhr ) {
					if ( xhr.lengthComputable ) {
						var percentComplete = xhr.loaded / xhr.total * 100;
					}
				};
				var onError = function ( xhr ) {
				};
				var loader = new THREE.OBJLoader( manager );
				var fitxerSat="imatges/sat"+parametres.panells+".obj";
				
				loader.load( fitxerSat, function ( object ) {
					object.traverse( function ( child ) {
						if ( child instanceof THREE.Mesh ) {
							child.material=new THREE.MeshStandardMaterial( { color: 0x565758, overdraw: true} );
                            child.receiveShadow = true;
						}
					} );
					object.scale.set(midaSatelit,midaSatelit,midaSatelit);
					for(s=0;s<maxOrb;s++) {
						for(i=0;i<maxSat;i++) {
							grupSat[s].remove(sat3D[s][i]);
							sat3D[s][i]=object.clone();
						}
					}					
				}, onProgress, onError );
			}

			function botoEliminarEstacio() {
				numEstacions--;
				meshTerra.remove(estacio3D[numEstacions]);
                for(i=0;i<maxSat;i++) {
                    scene.remove(link3D[i][numEstacions]);
                }
				app.stage.removeChild(puntEstacio[numEstacions]);	
				proximitat[numEstacions].clear();

			}

			function botoEliminarZona() {
				numZones--;
				app.stage.removeChild(puntZona[numZones]);	
				zonaProx[numZones].clear();
			}

			function botoAfegirEstacio() {
				alert("La nova estació s'ha ubicat provisionalment en el mapa.\nPots canviar la ubicació de les estacions arrossegant-les\namb el ratolí.")
				angleLatEstacio[numEstacions]=10*Math.PI/180;
				angleLonEstacio[numEstacions]=0;

				estacio3D[numEstacions]= new THREE.Mesh( geometryEstacio3D, materialEstacio3D );
				meshTerra.add(estacio3D[numEstacions]);	

				puntEstacio[numEstacions]=new PIXI.Sprite(PIXI.loader.resources["imatges/estacio_punt.png"].texture);
				puntEstacio[numEstacions].index=numEstacions;
				puntEstacio[numEstacions].interactive = true;
				puntEstacio[numEstacions].buttonMode = true;
				puntEstacio[numEstacions].on('pointerdown', onDragStartEst);
				puntEstacio[numEstacions].on('pointermove', onDragMove);
				puntEstacio[numEstacions].on('pointerup', onDragEndEst);
				app.stage.addChild(puntEstacio[numEstacions]);	

				mouEstacio(numEstacions);
				numEstacions++;
			}

			function botoAfegirZona() {
				alert("La nova zona d\'estudi s'ha ubicat provisionalment en el mapa.\nPots canviar la ubicació de les zones d\'estudi arrossegant-les\namb el ratolí.")
				angleLatZona[numZones]=45*Math.PI/180;
				angleLonZona[numZones]=90*Math.PI/180;

				puntZona[numZones]=new PIXI.Sprite(PIXI.loader.resources["imatges/zona_punt.png"].texture);
				puntZona[numZones].index=numZones;
				puntZona[numZones].interactive = true;
				puntZona[numZones].buttonMode = true;
				puntZona[numZones].on('pointerdown', onDragStartZona);
				puntZona[numZones].on('pointermove', onDragMove);
				puntZona[numZones].on('pointerup', onDragEndZona);
				app.stage.addChild(puntZona[numZones]);	

				mouZona(numZones);
				numZones++;
			}

			function canviaRadiProximitat() {	
				var distanciaZona=parametres.radiProximitat*1000/rTerra;			
				for(j=0;j<numEstacions;j++) {		
					proximitat[j].clear();
					if (proximitat[j]==undefined) {
						proximitat[j] = new PIXI.Graphics();
					}
					app.stage.addChild(proximitat[j]);
					proximitat[j].position.set(centreMapaX,centreMapaY);	
					proximitat[j].lineStyle(1, 0xFF0000);

					for (i=0;i<=360;i+=stepAngle) {
						azimuth=i*Math.PI/180;
						var novCoord=novesCoordenades(angleLatEstacio[j],angleLonEstacio[j],azimuth,distanciaZona);
						if(i==0) {
							proximitat[j].moveTo(midaMapa*novCoord.y/Math.PI,-midaMapa*novCoord.x/Math.PI);
						} else {
							proximitat[j].lineTo(midaMapa*novCoord.y/Math.PI,-midaMapa*novCoord.x/Math.PI);
						}
					}
				}
			}

			function canviaRadiZona() {	
				var distanciaZona=parametres.radiZona*1000/rTerra;			
				for(j=0;j<numZones;j++) {		
					zonaProx[j].clear();
					if (zonaProx[j]==undefined) {
						zonaProx[j] = new PIXI.Graphics();
					}
					app.stage.addChild(zonaProx[j]);
					zonaProx[j].position.set(centreMapaX,centreMapaY);	
					zonaProx[j].lineStyle(1, 0x872D00);

					for (i=0;i<=360;i+=stepAngle) {
						azimuth=i*Math.PI/180;
						var novCoord=novesCoordenades(angleLatZona[j],angleLonZona[j],azimuth,distanciaZona);
						if(i==0) {
							zonaProx[j].moveTo(midaMapa*novCoord.y/Math.PI,-midaMapa*novCoord.x/Math.PI);
						} else {
							zonaProx[j].lineTo(midaMapa*novCoord.y/Math.PI,-midaMapa*novCoord.x/Math.PI);
						}
					}
				}
			}

            function canviaNombre() {
                for(i=0;i<maxSat;i++) {
                    for(j=0;j<numEstacions;j++) {
                        scene.remove(link3D[i][j]);
                    }
                }
                canviaParametres();
            }

			function mouEstacio(numEst) {
				estacio3D[numEst].position.x=Math.sin(Math.PI/2-angleLatEstacio[numEst])*Math.cos(angleLonEstacio[numEst]);
				estacio3D[numEst].position.y=Math.sin(Math.PI/2-angleLatEstacio[numEst])*Math.sin(angleLonEstacio[numEst]);
				estacio3D[numEst].position.z=Math.cos(Math.PI/2-angleLatEstacio[numEst]);

				var distanciaZona=parametres.radiProximitat*1000/rTerra;

				puntEstacio[numEst].x=centreMapaX+midaMapa*angleLonEstacio[numEst]/Math.PI-radiPunt;
				puntEstacio[numEst].y=centreMapaY-midaMapa*angleLatEstacio[numEst]/Math.PI-radiPunt;
				if (proximitat[numEst]==undefined) {
					proximitat[numEst] = new PIXI.Graphics();
				}
				app.stage.addChild(proximitat[numEst]);
				proximitat[numEst].position.set(centreMapaX,centreMapaY);	
				proximitat[numEst].lineStyle(1, 0xFF0000);	

				for (i=0;i<=360;i+=stepAngle) {
					azimuth=i*Math.PI/180;
					var novCoord=novesCoordenades(angleLatEstacio[numEst],angleLonEstacio[numEst],azimuth,distanciaZona)
					if(i==0) {
						proximitat[numEst].moveTo(midaMapa*novCoord.y/Math.PI,-midaMapa*novCoord.x/Math.PI);
					} else {
						proximitat[numEst].lineTo(midaMapa*novCoord.y/Math.PI,-midaMapa*novCoord.x/Math.PI);
					}
				}			
			}

			function mouZona(numZona) {
				var distanciaZona=parametres.radiZona*1000/rTerra;

				puntZona[numZona].x=centreMapaX+midaMapa*angleLonZona[numZona]/Math.PI-radiPunt;
				puntZona[numZona].y=centreMapaY-midaMapa*angleLatZona[numZona]/Math.PI-radiPunt;
				if (zonaProx[numZona]==undefined) {
					zonaProx[numZona] = new PIXI.Graphics();
				}
				app.stage.addChild(zonaProx[numZona]);
				zonaProx[numZona].position.set(centreMapaX,centreMapaY);	
				zonaProx[numZona].lineStyle(1, 0x872D00);

				for (i=0;i<=360;i+=stepAngle) {
					azimuth=i*Math.PI/180;
					var novCoord=novesCoordenades(angleLatZona[numZona],angleLonZona[numZona],azimuth,distanciaZona)
					if(i==0) {
						zonaProx[numZona].moveTo(midaMapa*novCoord.y/Math.PI,-midaMapa*novCoord.x/Math.PI);
					} else {
						zonaProx[numZona].lineTo(midaMapa*novCoord.y/Math.PI,-midaMapa*novCoord.x/Math.PI);
					}
				}
			}

			function distancia(lat1,lat2,lon1,lon2) {			 	
				var dfi = (lat2-lat1);
				var dlambda = (lon2-lon1);
				var a = Math.sin(dfi/2) * Math.sin(dfi/2) +
						Math.cos(lat1) * Math.cos(lat2) *
						Math.sin(dlambda/2) * Math.sin(dlambda/2);
				var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
				var d = rTerra * c;
				return d;
			}

			function novesCoordenades(fi1, lambda1, azimuth, distance) {
				var delta = distance;
				var deltafi = delta * Math.cos(azimuth);
				var fi2 = fi1 + deltafi;
				var deltapsi = Math.log(Math.tan(fi2/2+Math.PI/4)/Math.tan(fi1/2+Math.PI/4));
				var q = Math.abs(deltapsi) > 10e-12 ? deltafi / deltapsi : Math.cos(fi1);
				var deltalambda = delta*Math.sin(azimuth)/q;
				var lambda2 = lambda1 + deltalambda;
				if (fi2>Math.PI/2) {fi2=Math.PI/2;}
				if (fi2<-Math.PI/2) {fi2=-Math.PI/2;}
				if (lambda2>Math.PI) {lambda2=Math.PI;}
				if (lambda2<-Math.PI) {lambda2=-Math.PI;}
				return new THREE.Vector3(fi2,lambda2,0);
			}
			
			function botoInfoSensors() {	

			    $.ajax({
    	    		type: "GET",
					contentType: "application/json; charset=utf-8",		    	    		
					url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQgE509E8sh-fxq5pvy9LjjUSC4AHoJaSdqTW0xbFeS9MV6CpT1JeAgk3WhGrlQPBrU1qFX-TXEl3YZ/pub?gid=0&single=true&output=tsv",
        			dataType: "text",
        			success: function(data) {processData(data);}
     			});

				function processData(allText) {
					var csv=allText;
  					var msgDiv="<table style='width:100%'>";

					var lines=csv.split("\n");

  					row_sen = [];

					var nf = Intl.NumberFormat();

					for(var i=0; i<lines.length; i++) {
	  					row_sen[i]=lines[i].split("\t");
	  					msgDiv +="<tr>";
	  					if (i>0){
	  						msgDiv +="<td style='border: 1px solid #cacaca; padding:3px;'><input type='checkbox' class='sensor' name='sensor_"+i+"' id='sensor_"+i+"' onchange='calPotencia()'/></td>";		
	  					} else {
	  						msgDiv +="<td style='border: 1px solid #cacaca; padding:3px'></td>"
	  					}
  						for(var c=0; c<row_sen[i].length; c++) {	  		
  							var senVal=row_sen[i][c];
							if(i==0) {
								msgDiv +="<td style='border: 1px solid #cacaca; padding:3px; text-align:center'><b>"+senVal+"</b></td>";
							} else {
								if(c==3 || c==4) {
									msgDiv +="<td style='border: 1px solid #cacaca; text-align: right; padding:3px;'>"+nf.format(senVal)+"</td>";
								} else {
									if(c==5) {
										msgDiv +="<td style='border: 1px solid #cacaca; padding:3px'><img src='"+senVal+"' height='100' class='center'></td>";
									} else {
										if (c==100){
											msgDiv +="<td style='border: 1px solid #cacaca; padding:3px'>"+senVal+"<br><button data-toggle='collapse' data-target='#demo'>Més informació</button><div id='demo' class='collapse'>Lorem ipsum dolor text....</div></td>";
										} else {
											msgDiv +="<td style='border: 1px solid #cacaca; padding:3px'>"+senVal+"</td>";
										}
									}
								}
						  }
  						}
  						//var senVal=row_sen[i][c];  						
  						//msgDiv +="<td style='border: 1px solid #cacaca; padding:3px'><img src='"+senVal+"' style='width:30%'/></td>";
  						//msgDiv +="<td style='border: 1px solid #cacaca; padding:3px'><button id='"+row_sen[i][1].substring(1,row_sen[i][1].length-1)+"'>Més informació</button></td>";  							
	  					msgDiv +="</tr>";  						
					}		  

    				msgDiv +="</table>";
    				msgDiv +="<hr>";    
    				msgDiv +="<table style='width:100%'>";
		        	msgDiv +="<tr id='potSensors'><td style='width:50%; background-color: #cacaca'>Potència necessària (W): 0</td>";//<td style='width:50%; background-color: #cacaca'>Panells solars : 1</td></tr>";
    				msgDiv +="<tr id='disSensors'><td style='width:50%; background-color: #cacaca'>Ocupació d'espai de disc (kb/s): 0</td>";//<td style='width:50%; background-color: #cacaca'>Unitats de disc : 1</td></tr>";    				    				
    				msgDiv +="</table>";    				

					$("#modalHeader").html("Sensors que incorpora el satèl·lit");
					$("#missatge").html(msgDiv);
					$("#finestraInfo").css({"visibility":"visible"});
					$("#finestraInfo").modal('show');	

					munSensors=lines.length-1;
					if (sensorsIniciats) {
						for(var i=1; i<lines.length; i++) {
							if (sensor[i]) {
								console.log("[id='sensor_"+i+"']");
								$("[id='sensor_"+i+"']").prop("checked",true);
							}
						}
					}	
					sensorsIniciats=true;    		
				}
			}	

			var row_mis=[];
			carregaMissions();
			var nM=0; //index de la missió 

			function carregaMissions() {			 	
				$.ajax({
					type: "GET",
					contentType: "application/json; charset=utf-8",		
					url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSjqpRYGZPowGnv70k6bKUOz7CjigpLQIoJZkGHEQlVGpDyH-XNjSMdPiEwtaxFLE_Rjgig-afk8aFD/pub?gid=1727080996&single=true&output=tsv",
					dataType: "text",
					success: function (dades) {
						row_mis=dades.split('\n');
						for (i=0;i<row_mis.length;i++){
							row_mis[i]=row_mis[i].split('\t');
						}
						$("#taulaMissions").show();
						$("#selMissio").show();
					}
				});
			}

			function botoInfoMissions() {			 	
				var msgDiv="<table style='width:100%;'>";
				//for(var i=0; i<row_mis.length; i++) {
				for(var i=0; i<7; i++) {					
					msgDiv +="<tr>";
					for(var c=0; c<row_mis[i].length; c++) {	  								
						var senVal=row_mis[i][c];	
						console.log(c,senVal);
						if(i==0) {
							msgDiv +="<td style='border: 1px solid #cacaca; padding:3px; text-align:center;'><b>"+senVal+"</b></td>";
						}	else {
							if (c==100){
								msgDiv +="<td style='border: 1px solid #cacaca; padding:3px;'>"+senVal+"<br><button data-toggle='collapse' data-target='#demo'>Més informació</button><div id='demo' class='collapse'>Lorem ipsum dolor text....</div></td>";
							} else {
							 if (c==3) {	
									msgDiv +="<td style='border: 1px solid #cacaca; padding:3px;'><a href='"+senVal+"' target='_blank'><img src='"+senVal+"' style='max-height:100px' class='center'></a></td>";														
								} else {	
									if (c==4) {
										msgDiv +="<td style='border: 1px solid #cacaca; padding:3px'>";
										var enll=senVal.split(',');
										for (ii=0;ii<enll.length;ii++){
											msgDiv +="<br><a href='"+enll[ii]+"' target='_blank'>Enllaç "+parseInt(ii+1)+"</a>";
										}
										msgDiv +="</td>";
										//msgDiv +="<td style='border: 1px solid #cacaca; padding:3px'><a href='"+senVal+"' target='_blank'>Enllaç</a></td>";	
									} else {
										msgDiv +="<td style='border: 1px solid #cacaca; padding:3px;'>"+senVal+"</td>";
									}
								}
							}
						}
					}
					msgDiv +="</tr>";  
				}
				msgDiv +="</table>";
				$("#modalHeader").html("Relació de missions");
				$("#missatge").html(msgDiv);
				$("#finestraInfo").css({"visibility":"visible"});
				$("#finestraInfo").modal('show');	    		
			}

			function botoSelMissio() {	
				nM=0;
				if (nM==0){
			    	var max=row_mis.length+1;
			    	var min=1;
					nM=parseInt(Math.random() * (max - min) + min);
				}
				var msgDiv="<div style='width:65%; float: left'>";
					//msgDiv +="<h3>Títol de la missió</td>";
					//msgDiv +="<h2>"+row_mis[nM][1]+"</h2>";
					msgDiv +="<h3>Tipologia de missió:</h3>";
					msgDiv +="<p class='descripcio'>"+row_mis[nM][0]+"</p>";
					msgDiv +="<h3>Descripció</h3>";
					msgDiv +="<p class='descripcio'>"+row_mis[nM][2]+"</p>";
					msgDiv +="<h3>Noticíes i enllaços d'interés</h3>";
					msgDiv +="<p class='descripcio'>"
					    var enll=row_mis[nM][4].split(',');
						for (i=0;i<enll.length;i++){
							msgDiv +="<br><a href='"+enll[i]+"' target='_blank'>Enllaç "+parseInt(i+1)+"</a>";
						}
					msgDiv +="</p>";
				msgDiv +="</div>";	
				msgDiv +="<div style='width:35%; float: right'>";	
					//msgDiv +="<h3>Imatges</h3>";
					msgDiv +="<div><img src='"+row_mis[nM][3]+"' style='max-height:50rem!important; width:100%!important'/></div>";
				msgDiv +="</div>";
				$("#modalHeader").html("Missió a desenvolupar: <br><br><p class='descripcio'>"+row_mis[nM][1]+"</p>");	
				$("#missatge").html(msgDiv);
				$("#finestraInfo").css({"visibility":"visible"});
				$("#finestraInfo").modal('show');	
				$("#selMissio").html("Visualitzar dades de la missió");
			}	

			function botoInfoParametres() {	

			    $.ajax({
    	    		type: "GET",
					contentType: "application/json; charset=utf-8",		    	    		
					url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSoLaetCgRNwwFYVuXVkrvWFLE_tQ3tK4aIyJajkz4n8sRjtK-djm7BiLry1DYLqZImnlDhqOxZeUix/pub?gid=0&single=true&output=tsv",
        			dataType: "text",
        			success: function(data) {processData(data);}
     			});

				function processData(allText) {
					var csv=allText;
  					var msgDiv="<table style='width:100%'>";

					var lines=csv.split("\n");

  					row_sen = [];
					//var nf = Intl.NumberFormat();

  					for(var i=0; i<lines.length; i++) {
	  					row_sen[i]=lines[i].split("\t");
	  					msgDiv +="<tr>";
  						for(var c=0; c<row_sen[i].length-2; c++) {	
  							var senVal=row_sen[i][c];
  							var estil="";
  							if (i==0){
  								var estil="background-color:#cacaca;";
  							} 
							if (c==100){
								msgDiv +="<td style='border: 1px solid #cacaca; padding:3px; "+estil+"'>"+senVal+"<br><button data-toggle='collapse' data-target='#demo'>Més informació</button><div id='demo' class='collapse'>Lorem ipsum dolor text....</div></td>";
							} else {
								msgDiv +="<td style='border: 1px solid #cacaca; padding:3px; "+estil+"'>"+senVal+"</td>";
							}
  						}
  						var senVal=row_sen[i][c];  						
  						//msgDiv +="<td style='border: 1px solid #cacaca; padding:3px'><img src='"+senVal+"' style='width:30%'/></td>";
	  					msgDiv +="</tr>";  						
  					}
    				msgDiv +="</table>";
					$("#modalHeader").html("Paràmetres configurables del simulador");	
					$("#missatge").html(msgDiv);
					$("#finestraInfo").css({"visibility":"visible"});
					$("#finestraInfo").modal('show');		    		
				}
			}	

			function calPotencia(){
				totalPot=0;
				totalDis=0;
				for (var s=1; s<row_sen.length; s++) {
					totalPot +=parseFloat(row_sen[s][3]);
					totalDis +=parseFloat(row_sen[s][4]);	
	   			}	

	   			potSensors = 0;
	   			disSensors = 0;			   		
	   			for (var s=1; s<row_sen.length; s++) {
	   				if ($("#sensor_"+s).prop("checked")){
	   					//potSensors +=parseFloat(row_sen[s][3].substring(1,row_sen[s][3].length-1));
	   					//disSensors +=parseFloat(row_sen[s][4].substring(1,row_sen[s][4].length-1));	
						potSensors +=parseFloat(row_sen[s][3]);
						disSensors +=parseFloat(row_sen[s][4]);
						sensor[s]=true;   
	   				} else {
						sensor[s]=false;
					}
	   			}				   		

				var nPanells=Math.ceil(potSensors/totalPot*5);
	   			var nDiscs=Math.ceil(disSensors/totalDis*5);
				if (nPanells==0) {nPanells=1;}
				if (nDiscs==0) {nDiscs=1;}
				var nf = Intl.NumberFormat();
	        	$('#potSensors').html("<td style='width:50%; background-color: #cacaca'>Potència necessària (W): "+nf.format(potSensors)+"</td>");//<td style='width:50%; background-color: #cacaca'>Panells solars : "+nPanells+"</td>")
				$('#disSensors').html("<td style='width:50%; background-color: #cacaca'>Ocupació d'espai de disc (kb/s): "+nf.format(disSensors)+"</td>");//<td style='width:50%; background-color: #cacaca'>Unitats de disc : "+nDiscs+"</td>");
        		//folder4.__controllers[0].setValue(nPanells);				
        		//folder4.__controllers[1].setValue(nDiscs);				        		
			}	

			function botoInfoSatelit() { 	
				var msgDiv="<iframe src='https://edumet.cat/areatac/zenit/visor-zenit.html' height='600' width='75%'></iframe>" 
				$("#modalHeader").html("Informació del satèl·lit");			
				$("#missatge").html(msgDiv);
				$("#finestraInfo").css({"visibility":"visible"});
				$("#finestraInfo").modal('show');		    		
			}				
		</script>
	</body>
</html>