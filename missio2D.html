<!DOCTYPE html>
<html lang="ca">
	<head>
		<title>Missió</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				background-color: #000;	margin: 0 0 0 0; padding: 0 0 0 0; border: none; cursor: default;
			}
			#container {
				height: 100%;
				width: 100%;
				display: flex;
			}
			#content {
				width: 60%;
			}
			#content2 {
				width: 40%;
			}
			#dat {
				user-select: none; position: absolute; left: 0;	top: 0;	z-Index: 200;
			}
			.modal-dialog{
   				background-color: white;
   				width: 75% !important;
			}
			.modal-header{
   				background-color: rgb(224, 236, 247);
			}
			.modal-footer{
  				clear:both;
			}
			.dg .c input[type=text] {                                                    
				line-height:normal;                                                                  
			} 
			.dg .c div {
				box-sizing: content-box;                                                             
			}		
		</style>
	</head>
	<body>		
		
		<div id="container">
			<div id="dat"></div>
			<div id="content">
			</div>
			<div id="content2">
			</div>
		</div>
		<div style="height: 300px">
			<canvas id="cnvSil" width=512 height=256></canvas>
			<canvas id="cnvFis" width=512 height=256></canvas>
		</div>
		<div style="clear:both">
			<button type="button" onclick="llenSat()">Inici captura</button> 
		</div>

		<!-- Modal -->
		<div id="finestraInfo" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" width='90%'>
			<div class="modal-dialog">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
					<h3 id="modalHeader">Informació dels sensors disponibles</h3>
				</div>
				<div class="modal-body" id="missatge">
					<iframe src="https://docs.google.com/spreadsheets/d/1Ba-fxzhfwNNLMs_uMRLbJCzAuFO2ReOXzoOytcYsUOw/edit#gid=1727080996" height="600" width="75%"></iframe>           	
				</div>
				<div class="modal-footer">
					<button class="btn" data-dismiss="modal" aria-hidden="true">Tancar</button>
				</div>
			</div>
		</div>

		<script src="https://code.jquery.com/jquery-1.12.4.js"></script>     

		<!-- Bootstrap -->
		<!-- Latest compiled and minified CSS -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"> 

		<!-- Optional theme -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous"> 

		<!-- Latest compiled and minified JavaScript -->
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script> 

		<script src="../three.js/build/three.min.js"></script>
		<script src="../three.js/examples/js/renderers/Projector.js"></script>
		<script src="../three.js/examples/js/renderers/CanvasRenderer.js"></script>
		<script src="../three.js/examples/js/libs/dat.gui.min.js"></script>
		<script src="../three.js/examples/js/controls/OrbitControls.js"></script>
		<script src="../three.js/examples/js/loaders/OBJLoader.js"></script>
		<script src="../three.js/examples/js/Detector.js"></script>

		<script src="pixi.min.js"></script>

		<script>
			var container,  container2, content, content2, camera, camera2D, scene, scene2D, renderer;
			var meshTerra, llegenda, discs, bateria, orbita, tauler, mapa2D, oceans;
			var omegaSat, periodeSat, aOrbita, bOrbita, eOrbita, pOrbita;
			var angleInclinacio;
			var vEsferic;
			var geometrySat, geometryTrajectoria, materialTrajectoria, geometryLink2D, materialLink2D, geometryLink3D, materialLink3D, geometryDiscs, materialDiscs, geometryBateria, materialBateria, materialOrbita, geometryEstacio, materialEstacio, geometryEstacio3D, materialEstacio3D, geometryZona, materialZona;
			var textPeriode;
            var grupMon;
			var folder1,folder4;
			var quaternionTerra;
			var estacio=[];
			var estacio3D=[];
			var zona=[];
			var link2D=[];
			var link3D=[];
			var posLink2D=[];
			var posLink3D=[];
			var proximitat=[];
			var zonaProx=[];
			var numMove;
            var maxSat=1;
			var maxOrb=1;
            var sat2D=[];
            var sat3D=[];
			var grupSat=[];
			var angleEscombrat=[];
			var app;
			var puntSat=[];
			var puntEstacio=[];
			var puntZona=[];
			var tros=[];

			// CONSTANTS TERRA            
            const MU=398694790080000; // G * massa de la Terra, S.I.
			const rTerra=6458428; // radi de l'esfera terrestre, metres
			const segonsDia=23*3600+56*60+4; // nombre de segons que té un dia
			const omega=2*Math.PI/segonsDia; // freqüencia angular de rotació de la Terra entorn al seu eix, rad/s
            const angleTerra=23.4369*Math.PI/180; // angle d'inclinació de l'eix terrestre, rad
			const omegaSol=omega/365.256363; // freqüencia angular de translació de la Terra entorn al Sol, rad/s

			// CONSTANTS SIMULACIÓ
			const maxPoints = 4096; // màxim de punts en la trajectòria
			const maxPointsGraph = 8192; // màxim de punts en les gràfiques
			const shiftCount=1;	// al cap de quants renderings s'agafa un punt de la trajectòria
			const midaSatelit=0.04; // escala d'ampliació del OBJ del satèl·lit
            const centreX=0; // origen en X del mapa 2D de la Terra
			const centreY=-1.75; // origen en Y del mapa 2D de la Terra
			const marge2D=0.1; // marge horitzontal i vertical entre els límits del tauler de gràfiques i els eixos XY
			const mAmplada=1.5; // amplada del mapa 2D de la Terra
			const mAlsada=mAmplada/2; // alçada del mapa 2D de la Terra
			const origenX=centreX - mAmplada + marge2D; // coordenada X de l'origen de coordenades al tauler de gràfiques
			const origenY=centreY + mAlsada + 0.1 + marge2D; // coordenada Y de l'origen de coordenades al tauler de gràfiques
			const finalX=centreX + mAmplada - marge2D; // coordenada X máxima en el tauler de gràfiques
			const finalY=centreY +  4 * mAlsada + 0.1 - marge2D; // coordenada Y máxima en el tauler de gràfiques
			const shiftZ=0.01; // distància entre objectes en la coordenada Z en l'escena 2D. 0,mapa,tauler. 1,sat2D, estacions, zones, proximitats, trajectòria, gràfiques i llegenda
			const stepAngle=1; // al cap de quants graus es considera un nou punt en la zona de proximitat
			const perCent2D=0.4; // tant per u que ocupa l'escena 2D de la dreta
			const ample = 0.6;
			const ampleRight = 0.4;

			// CONSTANTS DESPESA DISC I BATERIA
			const ritmeDiscCamera=-0.001;
			const ritmeDiscRadar=-0.001;
			const ritmeDiscTransfer=0.064;

			const ritmeBateriaCamera=-0.005;
			const ritmeBateriaRadar=-0.005;
			const ritmeBateriaDiscs=-0.0001;
			const ritmeBateriaTransfer=-0.005;
			const ritmeBateriaPanell=0.002;

            // VARIABLES DE SIMULACIÓ	
			var ambWebgl; // el navegador suporta WebGL			
            var temps, previousTime, interval; // en segons
			var count; // comptador de punts en la trajectòria
			var countGraph; // comptador de punts en les gràfiques
			var steps; // comptador de renderings
			var enPausa = true; // animació
			var dintre = []; // dins de la zona de proximitat
			var dintreZona = []; // dins de la zona d'estudi
			var ambLlum = true; // fora de la zona d'ombra
			var maxCountGraph; // nombre de punts necessaris en les gràfiques per representar un dia sencer
			var diaSencer; // ha transcorregut més d'un dia sencer (boolean)
			var nivellDiscs; // espai d'emmagatzematge de dades sense ocupar (%)
			var nivellBateria; // nivell de càrrega de les bateries (%)
			var vectorLlum; // vector amb origen al Sol i final a la Terra (unitari)
			var longitudAnterior; // en el traçat de la trajectòria, longitud del satèl·lit 2D en l'anterior rendering
			var dragging=false; // arrossegant un element del mapa
			var dragEstacio; // arrossegant una estació de seguiment (i no una zona d'estudi)
			var angleLatEstacio=[]; // array de latituds de les estacions
			var angleLonEstacio=[]; // array de longituds de les estacions
			angleLatEstacio[0]=41*Math.PI/180; // latitud inicial de l'estació per defecte
			angleLonEstacio[0]=2*Math.PI/180; // longitud inicial de l'estació per defecte
			var angleLatZona=[]; // array de latituds de les zones d'estudi
			var angleLonZona=[]; // array de longituds de les zones d'estudi
			angleLatZona[0]=-50*Math.PI/180; // latitud inicial de la zona d'estudi per defecte
			angleLonZona[0]=-90*Math.PI/180; // longitud inicial de la zona d'estudi per defecte
			var numEstacions=1; // nombre actual d'estacions
			var numZones=1; // nombre actual de zones d'estudi
			var satMin=1; // distància mínima entre el centre de la Terra i el Satèl·lit (en referència a 1, radi de la Terra)
			var botoIniciar;
			var estil;
			var centreMapaX, centreMapaY;

			// SENSORS
			var row_sen=[];
			var potSensors=0;
			var disSensors=0;	

			function initGUI() {
				var menuDiv = document.getElementById( 'dat' );
				var gui = new dat.GUI({autoPlace: false, width:350});
				menuDiv.appendChild( gui.domElement );
				folder1 = gui.addFolder( 'ÒRBITA DEL SATÈL·LIT' );
				folder1.add( parametres, "longitud", -180, 180, 1 ).name("Longitud node asc.").onChange( canviaParametres );
				folder1.add( parametres, "inclinacio", 0, 90, 1 ).name("Inclinació").onChange( canviaParametres );
				folder1.add( parametres, "argPerigeu", -180, 180, 1 ).name("Arg. del perigeu").onChange( canviaParametres );
				folder1.add( parametres, "aOrbita", satMin*rTerra/1000, 50000, 100 ).name("Semieix major").onChange( canviaSemieix );
				folder1.add( parametres, "excentricitat", 0, 1-satMin*rTerra/parametres.aOrbita/1000, 0.01 ).name("Excentricitat").onChange( canviaExcentricitat );
				folder1.add( parametres, "nSat", 1, maxSat, 1 ).name("Satèl·lits en òrbita").onChange( canviaNombre );
				//folder1.add( parametres, "nOrb", 1, maxSat, 1 ).name("Quantitat d'òrbites").onChange( canviaNombre );
                //folder1.add( parametres, "anomalia", -180, 180, 1 ).name("Anomalia veritable").onChange( canviaParametres );
				textPeriode=folder1.add( parametres, "display");
				textPeriode.name("PERÍODE :");
				textPeriode.domElement.hidden = true;
				var estilPeriode = textPeriode.domElement.previousSibling.style;
				estilPeriode.textAlign = 'center';
				estilPeriode.width= '100%';
				var folder2 = gui.addFolder( 'ESTACIONS DE SEGUIMENT' );
                folder2.add( parametres, "radiProximitat", 100, 4000, 100 ).name("Radi de proximitat").onChange( canviaRadiProximitat );
				folder2.add( parametres, "afegirEstacio").name("Afegir estació");
				folder2.add( parametres, "eliminarEstacio").name("Eliminar estació");
				var folder6 = gui.addFolder( 'ZONES D\'ESTUDI' );
                folder6.add( parametres, "radiZona", 100, 8000, 100 ).name("Radi de les zones").onChange( canviaRadiZona );
				folder6.add( parametres, "afegirZona").name("Afegir zona");
				folder6.add( parametres, "eliminarZona").name("Eliminar zona");
				
				var folder7 = gui.addFolder( 'SIMULADOR' );				
				folder7.add( parametres, "infoParametres").name("INFO paràmetres");	
				//folder7.open();
				//*/

				var folder3 = gui.addFolder( 'SIMULACIÓ' );				
				//folder3.add( parametres, "mapa", [ 'mapa_simple.png','mapa_fisic.png', 'mapa_politic.png','mapa_gel.png' ]).name("Tipus de mapa").onChange( canviaMapa );
				//folder3.add( parametres, "veureLine").name("Mostrar trajectòria").onChange( veureLine );
				folder3.add( parametres, "velAnimacio",1,10,1).name("Velocitat d'animació").onChange( canviaParametres );
				botoIniciar = folder3.add( parametres, "pausa");
				botoIniciar.name("I N I C I A R");
				estil = botoIniciar.domElement.previousSibling.style;
				estil.backgroundColor = 'green';
				estil.textAlign = 'center';
				estil.width= '100%';
				//folder1.open();
                //folder2.open();
				//folder6.open();
				folder3.open();
				//*

				
				var guiDret = new dat.GUI({width:350});
				folder4 = guiDret.addFolder( 'EQUIPAMENT DEL SATÈL·LIT' );
				folder4.add( parametres, "panells", 1, 5, 1 ).name("Panells solars"); //.onChange( canviaSatelit );
				folder4.add( parametres, "discs", 1, 5, 1 ).name("Unitats de disc");
				folder4.add( parametres, "cameres", 0, 5, 1 ).name("Càmeres òptiques");
				folder4.add( parametres, "radars", 0, 5, 1 ).name("Sistemes de radar");
				folder4.open();
				//var folder5 = guiDret.addFolder( 'INFORMACIÓ ADDICIONAL' );
				//folder5.add( parametres, "infoSatelit").name("Informació del satèl·lit");	
				//folder5.add( parametres, "infoSensors").name("Informació del sensors");		
				//folder5.add( parametres, "infoMissions").name("Informació de les missions");						
				//folder5.add( parametres, "selMissio").name("Selecciona una missió");					
				//folder5.open();
			}

			init();
			function init() {
				// PARÀMETRES DE SIMULACIÓ
				parametres = {
					longitud: 0, // de l'òrbita del satèl·lit, graus
					inclinacio: 45, // de l'òrbita del satèl·lit, graus
					argPerigeu: 0, // argument del perigeu, graus
					aOrbita: 10000, // semieix major de l'òrbita el·líptica, km
					excentricitat: 0, // excentricitat de l'òrbita (entre 0 i 1)
					anomalia:0, // anomalia veritable, graus
                    nSat:1, // quantitat de satèl·lits a l'òrbita
					nOrb:1, // quantitat d'òrbites
                    radiProximitat: 3000, // radi de la zona de proximitat a l'estació, km
					radiZona: 5000, // radi de la zona d'estudi, km
					afegirEstacio: botoAfegirEstacio,
					eliminarEstacio: botoEliminarEstacio,
					afegirZona: botoAfegirZona,
					eliminarZona: botoEliminarZona,
					mapa2D: 'mapa_fisic_silueta.png', // fitxer de textura del mapa
					mapa3D: 'mapa_fisic.png', // fitxer de textura del mapa
					veureLine: false, // veure o no la trajectòria
					velAnimacio: 3, // velocitat de l'animació
					display : true, // visualitzador del període del satèl·lit. El valor booleà no té cap efecte
					pausa: botoPausa, // botó per pausar o reprendre la simulació
					infoSatelit: botoInfoSatelit, // finestra modal amb el satèl·lit 3D
					infoSensors: botoInfoSensors, // finestra modal amb informació sobre els sensors
					infoMissions: botoInfoMissions, // finestra modal amb informació sobre els sensors					
					selMissio: botoSelMissio, //selecciona una missió
					infoParametres: botoInfoParametres, //Presenta la inforació dels paràmetres configurables del simulador
					panells: 1, 
					discs:1,
					cameres: 1,
					radars: 1
				};

				container = document.getElementById( 'content' );
				container2 = document.getElementById( 'content2' );
                // CÀMERA
				camera = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 1, 1000 );
				camera.up.set(0,0,1);
				camera.position.x = 4; // red
				camera.position.y = 0; // green
				camera.position.z = 0; // blue

				//camera2D = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 4, 4.5);
				//camera2D.position.z = 4.5; 

				scene = new THREE.Scene();
				scene.background = new THREE.Color( 0x131313 );

				//scene2D = new THREE.Scene();

                // LLUM
                var ambientLight = new THREE.AmbientLight( 0x444444 ); // 10%
                scene.add(ambientLight);

                var directionalLight = new THREE.DirectionalLight( 0xffffff, 1);
				
                vectorLlum=new THREE.Vector3(-1,0,0);
				directionalLight.position.set(-vectorLlum.x, -vectorLlum.y, -vectorLlum.z);
				directionalLight.castShadow=true;
                scene.add( directionalLight );     

                // EIX TERRA
                var dir = new THREE.Vector3(0,Math.sin(angleTerra),Math.cos(angleTerra));
                var origin = new THREE.Vector3( 0, 0, 0 );
                var arrowHelper = new THREE.ArrowHelper( dir, origin, 1.1, 0x555555, 0.075, 0.05);
                scene.add( arrowHelper );

				// TERRA I MAPA 2D
				canviaMapa();

				// SATÈL·LIT 3D
				grupMon=new THREE.Group();
				var manager = new THREE.LoadingManager();
				manager.onProgress = function ( item, loaded, total ) {					
					for(s=0;s<maxOrb;s++) {
						grupSat[s]=new THREE.Group();
						grupMon.add(grupSat[s]);
					}
					canviaParametres();
					animate();
				};
				var onProgress = function ( xhr ) {
					if ( xhr.lengthComputable ) {
						var percentComplete = xhr.loaded / xhr.total * 100;
					}
				};
				var onError = function ( xhr ) {
				};
				var loader = new THREE.OBJLoader( manager );
				loader.load( 'imatges/sat.obj', function ( object ) {
					object.traverse( function ( child ) {
						if ( child instanceof THREE.Mesh ) {
							child.material=new THREE.MeshStandardMaterial( { color: 0x565758, overdraw: true} );
                            child.receiveShadow = true;
						}
					} );
					object.scale.set(midaSatelit,midaSatelit,midaSatelit);
					for(s=0;s<maxOrb;s++) {
						sat3D[s]=[];
						for(i=0;i<maxSat;i++) {							
							sat3D[s][i]=object.clone();
						}
					}					
				}, onProgress, onError );				

				// SATÈL·LIT 2D
                materialSat2D = new THREE.MeshBasicMaterial( { color: 0xffffff} );
				var geometrySat2D = new THREE.CircleGeometry(0.02);
                for(i=0;i<maxSat;i++) {
				    sat2D[i] = new THREE.Mesh( geometrySat2D, materialSat2D );
                }
				
				// MÀSCARA OCEANS
				var managerOceans = new THREE.LoadingManager();
				managerOceans.onProgress = function ( item, loaded, total ) {
				//scene2D.add(oceans);
				};
				var loader = new THREE.OBJLoader( managerOceans );
				loader.load( 'imatges/oceans.obj', function ( object ) {
					object.scale.set(0.0118,0.0118,0.0118);
					object.position.set(centreX,centreY,-shiftZ);
					oceans=object.clone();					
				}, onProgress, onError );

				// ÒRBITA
				materialOrbita = new THREE.LineBasicMaterial( { color : 0xffffff } );
				var geometryOrbita = new THREE.BufferGeometry();
				orbita = new THREE.Line( geometryOrbita, materialOrbita );

				// TRAJECTÒRIA
				materialTrajectoria = new THREE.LineBasicMaterial({ color: 0xffffff, linewidth: 1 });

				// LINK 2D
				materialLink2D = new THREE.LineBasicMaterial({ color: 0xffffff, linewidth: 1 });
				geometryLink2D = new THREE.BufferGeometry();
                for(i=0;i<maxSat;i++) {
                    link2D[i]=[];
				    link2D[i][0] = new THREE.Line(geometryLink2D, materialLink2D);
                    posLink2D[i]=[];
                }

				// LINK 3D
				materialLink3D = new THREE.LineBasicMaterial({ color: 0xffffff, linewidth: 1 });

				// DISCS
				materialDiscs = new THREE.LineBasicMaterial({ color: 0x0000ff, linewidth: 2	});

				// BATERIA
				materialBateria = new THREE.LineBasicMaterial({ color: 0x00ff00, linewidth: 2	});

				// ESTACIÓ 2D
				materialEstacio = new THREE.MeshBasicMaterial( { color: 0xff0000} );
				geometryEstacio = new THREE.CircleGeometry(0.03);
				estacio[0]= new THREE.Mesh( geometryEstacio, materialEstacio );
				//scene2D.add(estacio[0]);

				// ESTACIÓ 3D
				materialEstacio3D = new THREE.MeshBasicMaterial( { color: 0xff0000} );
				geometryEstacio3D = new THREE.SphereGeometry( 0.02, 6, 6 );
				estacio3D[0] = new THREE.Mesh( geometryEstacio3D, materialEstacio3D );
				//mouEstacio(0);

				// ZONA D'ESTUDI
				materialZona = new THREE.MeshBasicMaterial( { color: 0xffc300} );
				geometryZona = new THREE.CircleGeometry(0.03);
				zona[0]= new THREE.Mesh( geometryZona, materialZona );
				//scene2D.add(zona[0]);
				//mouZona(0);				

				// TAULER DE GRÀFIQUES	

				var loader = new THREE.TextureLoader();
				loader.load( 'imatges/'+"eixos2D.png", function ( texture ) {
					var geometryTauler = new THREE.PlaneGeometry(300/100,225/100);
					var materialTauler = new THREE.MeshBasicMaterial( {map: texture} );
					tauler = new THREE.Mesh( geometryTauler, materialTauler);
					tauler.position.x=centreX;
					tauler.position.y=centreY+2.5*mAlsada+0.1;
					tauler.position.z=0;
					//scene2D.add( tauler )
				} );

				loader = new THREE.TextureLoader();
				loader.load( 'imatges/'+"llegenda.png", function ( texture ) {
					var geometryLlegenda = new THREE.PlaneGeometry(203/200,46/200);
					var materialLlegenda = new THREE.MeshBasicMaterial( {map: texture} );
					llegenda = new THREE.Mesh( geometryLlegenda, materialLlegenda);
					llegenda.position.x=0.7;
					llegenda.position.y=centreY+1.15;
					llegenda.position.z=shiftZ;
					//scene2D.add( llegenda );
				} );

                // MÓN
                grupMon.setRotationFromAxisAngle(new THREE.Vector3(1,0,0),-angleTerra);
                scene.add(grupMon);
			
				// RENDERER
				if (Detector.webgl) {
					ambWebgl=true;
					renderer = new THREE.WebGLRenderer();
					renderer.shadowMap.enabled = true;
					renderer.shadowMap.type = THREE.PCFSoftShadowMap;
				} else {
					ambWebgl=false;
					renderer = new THREE.CanvasRenderer();
					console.log("WebGL no és compatible, renderitzant amb CanvasRenderer.");
					alert("Aquest navegador no és compatible amb WebGL,\nalgunes funcionalitats del simulador no estaran disponibles.");
				}
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth * ample, window.innerHeight );
				//renderer.autoClear = false;
				container.appendChild( renderer.domElement );
				//Create a Pixi Application
				app = new PIXI.Application({width: window.innerWidth * ampleRight, height: window.innerHeight});
				app.renderer.backgroundColor = 0x131313;
				//Add the canvas that Pixi automatically created for you to the HTML document
				container2.appendChild(app.view);	

				centreMapaX=window.innerWidth * ampleRight / 2;
				centreMapaY=window.innerHeight / 2;

				PIXI.loader
					.add("imatges/mapa_fisic.png")
					.add("imatges/mapa_fisic_silueta.png")
					.add("imatges/sat_punt.png")
					.add("imatges/estacio_punt.png")
					.add("imatges/zona_punt.png")
					.load(setup);
					function setup() {
						var silueta = new PIXI.Sprite(PIXI.loader.resources["imatges/mapa_fisic_silueta.png"].texture);
						silueta.x=centreMapaX-256;
						silueta.y=centreMapaY+128;
						app.stage.addChild(silueta);
						
						baseTx=PIXI.loader.resources["imatges/mapa_fisic.png"].texture;
						for(i=0;i<16*2;i++){
							tros[i]=[];
							for(j=0;j<16;j++) {
								var rectangle = new PIXI.Rectangle(i*16, j*16, 16, 16);
								texture = new PIXI.Texture(baseTx, rectangle);
								tros[i][j]= new PIXI.Sprite(texture);
								tros[i][j].x=centreMapaX - 256 + i * 16;
								tros[i][j].y=centreMapaY + 128 + j * 16;
								tros[i][j].visible=false;
								app.stage.addChild(tros[i][j]);
							}
						}

						puntEstacio[0]=new PIXI.Sprite(PIXI.loader.resources["imatges/estacio_punt.png"].texture);
						puntEstacio[0].index=0;
						puntEstacio[0].interactive = true;
						puntEstacio[0].buttonMode = true;
						puntEstacio[0].on('mousedown', onDragStartEst);
						puntEstacio[0].on('mousemove', onDragMove);
						puntEstacio[0].on('mouseup', onDragEndEst);
						app.stage.addChild(puntEstacio[0]);

						puntZona[0]=new PIXI.Sprite(PIXI.loader.resources["imatges/zona_punt.png"].texture);
						puntZona[0].index=0;
						puntZona[0].interactive = true;
						puntZona[0].buttonMode = true;
						puntZona[0].on('mousedown', onDragStartZona);
						puntZona[0].on('mousemove', onDragMove);
						puntZona[0].on('mouseup', onDragEndZona);
						app.stage.addChild(puntZona[0]);

						mouEstacio(0);
						mouZona(0);

						for(i=0;i<maxSat;i++) {
				    		puntSat[i] = new PIXI.Sprite(PIXI.loader.resources["imatges/sat_punt.png"].texture);
							puntSat[i].x=centreMapaX-4;
							puntSat[i].y=centreMapaY-4;
							app.stage.addChild(puntSat[i]);
                		}
				}		
											
				controls = new THREE.OrbitControls( camera, renderer.domElement );
				window.addEventListener( 'resize', onWindowResize, false );
				//window.addEventListener( 'mousedown', onMouseDown, false );
				//window.addEventListener( 'mouseup', onMouseUp, false );
				//window.addEventListener( 'mousemove', onMouseMove, false );
				window.addEventListener( 'focus', onFocus, false );
				//window.addEventListener( 'touchstart', onTouchStart, false );
				//window.addEventListener( 'touchmove', onTouchMove, false );
				//window.addEventListener( 'touchend', onTouchEnd, false );

				initGUI();
			}

			function onFocus(){
				canviaParametres();
			}

			function onTouchStart(evt){
				//evt.preventDefault();
				//evt.stopPropagation();
				var touches = evt.changedTouches;
				getLatLon(parseInt(touches[0].clientX),parseInt(touches[0].clientY));
				//textPeriode.name('touch:'+parseInt(touches[0].clientX)+','+parseInt(touches[0].clientY));
				numMove=-1;			
				var i=0;
				do {					
					intersects=rayCaster.intersectObject(estacio[i],true);				
					if (intersects.length > 0) {
						//textPeriode.name("inside");
						numMove=i;
						controls.enabled=false;
						dragging=true;
						dragEstacio=true;
						//scene2D.remove(proximitat[numMove]);
					}
					i++;
				}
				while(numMove<0 && i<numEstacions);

				if (numMove<0) {
					i=0;
					do {					
						intersects=rayCaster.intersectObject(zona[i],true);				
						if (intersects.length > 0) {
							numMove=i;						
							controls.enabled=false;
							dragging=true;
							dragEstacio=false;
							//scene2D.remove(zonaProx[numMove]);
						}
						i++;
					}
					while(numMove<0 && i<numZones);
				}
			}

			function getLatLon(X,Y) {
				mousePosition = new THREE.Vector2();
				canvas = renderer.domElement;
				canvasPosition = $(canvas).position();
				rayCaster = new THREE.Raycaster();
				var left=(1-perCent2D)*window.innerWidth+1;
				var width=perCent2D*window.innerWidth-2;				

				mousePosition.x = ((X - left) / width) * 2 - 1;
				mousePosition.y = -((Y - canvasPosition.top) / canvas.height) * 2 + 1;
				//rayCaster.setFromCamera(mousePosition, camera2D);
			}

			function onDragStartEst(evt) {
				this.data = evt.data;
    			this.dragging = true;
				proximitat[this.index].clear();
			}

			function onDragMove(evt) {
				if (this.dragging)
				{
					var newPosition = this.data.getLocalPosition(this.parent);
					this.position.x = newPosition.x;
					this.position.y = newPosition.y;
				}
			}

			function onDragEndEst(evt) {
				this.dragging = false;
				//getLatLon(this.position.x,this.position.y);		
					/*if (dragEstacio) {
						intersects = rayCaster.intersectObject(oceans, true);
						if (intersects.length > 0) {
							alert("L'estació de seguiment ha d'estar en terra ferma,\nno pot ubicar-se a l'oceà.")
						} else {*/
							angleLatEstacio[this.index]=(-puntEstacio[this.index].position.y+centreMapaY)*Math.PI/256;
							angleLonEstacio[this.index]=(puntEstacio[this.index].position.x-centreMapaX)*Math.PI/256;
						//}
						mouEstacio(this.index);
					//} else {
						//angleLatZona[numMove]=(zona[numMove].position.y-centreY)*Math.PI/mAmplada;
						//angleLonZona[numMove]=(zona[numMove].position.x-centreX)*Math.PI/mAmplada;
						//mouZona(numMove);
					//}
				this.data = null;
			}

			function onDragStartZona(evt) {
				this.data = evt.data;
    			this.dragging = true;
				zonaProx[this.index].clear();
			}

			function onDragEndZona(evt) {
				this.dragging = false;
				angleLatZona[this.index]=(-puntZona[this.index].position.y+centreMapaY)*Math.PI/256;
				angleLonZona[this.index]=(puntZona[this.index].position.x-centreMapaX)*Math.PI/256;
				mouZona(this.index);
				this.data = null;
			}

			function onMouseDown(evt) {
				console.log("down");
				dragging=true;
				getLatLon(parseInt(evt.clientX),parseInt(evt.clientY));
				//textPeriode.name('mouse:'+parseInt(evt.clientX)+','+parseInt(evt.clientY))
				numMove=-1;			
				var i=0;
				do {					
					intersects=rayCaster.intersectObject(estacio[i],true);				
					if (intersects.length > 0) {
						numMove=i;						
						controls.enabled=false;
						dragging=true;
						dragEstacio=true;
						scene2D.remove(proximitat[numMove]);
					}
					i++;
				}
				while(numMove<0 && i<numEstacions);

				if (numMove<0) {
					i=0;
					do {					
						intersects=rayCaster.intersectObject(zona[i],true);				
						if (intersects.length > 0) {
							numMove=i;						
							controls.enabled=false;
							dragging=true;
							dragEstacio=false;
							scene2D.remove(zonaProx[numMove]);
						}
						i++;
					}
					while(numMove<0 && i<numZones);
				}
			};

			function onTouchMove(evt) {
				if (dragging) {
					evt.preventDefault();
					var touches = evt.changedTouches;
					getLatLon(parseInt(touches[0].clientX),parseInt(touches[0].clientY));
					intersects = rayCaster.intersectObject(mapa2D, true);
					if (dragEstacio) {
						if (intersects.length > 0) {
							estacio[numMove].position.x=intersects[0].point.x;
							estacio[numMove].position.y=intersects[0].point.y;
						}
					}
					else {
						if (intersects.length > 0) {
							zonaProx[numMove].position.x=intersects[0].point.x;
							zonaProx[numMove].position.y=intersects[0].point.y;
						}
						
					}
				}
			}

			function onMouseMove(evt) {				
				if (dragging) {
					console.log("move");
					var newPosition = this.data.getLocalPosition(this.parent);
        			this.position.x = newPosition.x;
        			this.position.y = newPosition.y;
					//evt.preventDefault();
					getLatLon(evt.clientX,evt.clientY);
					intersects = rayCaster.intersectObject(mapa2D, true);
					if (dragEstacio) {
						if (intersects.length > 0) {
							estacio[numMove].position.x=intersects[0].point.x;
							estacio[numMove].position.y=intersects[0].point.y;
						}
					}
					else {
						if (intersects.length > 0) {
							zona[numMove].position.x=intersects[0].point.x;
							zona[numMove].position.y=intersects[0].point.y;
						}
						
					}
				}
			}

			function onMouseUp(evt) {
				if (dragging) {
					console.log("down");
					dragging=false;
					evt.preventDefault();
					getLatLon(evt.clientX,evt.clientY);
					if (dragEstacio) {
						intersects = rayCaster.intersectObject(oceans, true);
						if (intersects.length > 0) {
							alert("L'estació de seguiment ha d'estar en terra ferma,\nno pot ubicar-se a l'oceà.")
						} else {
							angleLatEstacio[numMove]=(estacio[numMove].position.y-centreY)*Math.PI/mAmplada;
							angleLonEstacio[numMove]=(estacio[numMove].position.x-centreX)*Math.PI/mAmplada;
						}
						mouEstacio(numMove);
					} else {
						angleLatZona[numMove]=(zona[numMove].position.y-centreY)*Math.PI/mAmplada;
						angleLonZona[numMove]=(zona[numMove].position.x-centreX)*Math.PI/mAmplada;
						mouZona(numMove);
					}
					controls.reset();
					controls.enabled=true;					
					dragging=false;
				}
			}

			function botoPausa() {		
				enPausa=!enPausa;
				if (!enPausa) {
					estil.backgroundColor = 'IndianRed';
					botoIniciar.name("P A U S A R");
					previousTime=new Date().getTime();
					animate();
				} else {
					estil.backgroundColor = 'green';
					botoIniciar.name("C O N T I N U A R");
				}
			}

			function addGraph() {
				if(!enPausa) {
					if (temps>segonsDia) {
						if(!diaSencer) {
							finalCountGraph=countGraph;
							diaSencer=true;
						}
					}

					// APORTACIONS I DESPESES DE DISC I BATERIA

					var ritmeDisc=0;
					var ritmeBateria=0;
					var enregistrant=false;
					var transferint=false;

					if (ambLlum) { // Aportació d'energia solar
						ritmeBateria+=parametres.panells*ritmeBateriaPanell;
					}

					var zonaEstudi=0;
					do { // Despesa única de càmeres i radar quan s'està dins d'alguna de les zones d'estudi
						if (dintreZona[0][zonaEstudi]) {
							ritmeDisc+=parametres.cameres*ritmeDiscCamera;
							ritmeDisc+=parametres.radars*ritmeDiscRadar;
							ritmeBateria+=parametres.cameres*ritmeBateriaCamera;
							ritmeBateria+=parametres.radars*ritmeBateriaRadar;
							enregistrant=true;
						}
						zonaEstudi++;
					}
					while(!enregistrant && zonaEstudi<numZones)

					for(j=0;j<numEstacions;j++) { // Consum del transfer a totes les estacions properes
						if (dintre[0][j]) {
							ritmeDisc+=ritmeDiscTransfer;
							ritmeBateria+=ritmeBateriaTransfer;
							transferint=true;
						}
					}

					if (transferint || enregistrant) { // Consum energètic dels discs
						ritmeBateria+=parametres.discs*ritmeBateriaDiscs;
					}

					nivellDiscs+=parametres.velAnimacio*interval*shiftCount*ritmeDisc/parametres.discs;

					if (nivellDiscs>100) {
						nivellDiscs=100;
					}
					if (nivellDiscs<0) {
						nivellDiscs=0;
					}	

					nivellBateria+=parametres.velAnimacio*interval*shiftCount*ritmeBateria;

					if (nivellBateria>100) {
						nivellBateria=100;
					}
					if (nivellBateria<0) {
						nivellBateria=0;
					}			
						
					// Punts de les gràfiques

					if (diaSencer) {
						posDiscs[finalCountGraph * 3 + 0] = finalX;
						posDiscs[finalCountGraph * 3 + 1] = origenY+(finalY-origenY)/100*(100-nivellDiscs);
						posDiscs[finalCountGraph * 3 + 2] = shiftZ;	
						posBateria[finalCountGraph * 3 + 0] = finalX;
						posBateria[finalCountGraph * 3 + 1] = origenY+(finalY-origenY)/100*nivellBateria;
						posBateria[finalCountGraph * 3 + 2] = shiftZ;	
						for(i=0;i<finalCountGraph;i++){							
							posDiscs[i* 3 + 1] = posDiscs[i* 3 + 4];
							posBateria[i* 3 + 1] = posBateria[i* 3 + 4];
						}
					} else {
						posDiscs[countGraph * 3 + 0] = origenX+temps*(finalX-origenX)/segonsDia;
						posDiscs[countGraph * 3 + 1] = origenY+(finalY-origenY)/100*(100-nivellDiscs);
						posDiscs[countGraph * 3 + 2] = shiftZ;
						posBateria[countGraph * 3 + 0] = origenX+temps*(finalX-origenX)/segonsDia;
						posBateria[countGraph * 3 + 1] = origenY+(finalY-origenY)/100*nivellBateria;
						posBateria[countGraph * 3 + 2] = shiftZ;
						for(i=countGraph+1;i<maxPointsGraph;i++){							
							posDiscs[i* 3 + 2] = -100;
							posBateria[i* 3 + 2] = -100;
						}
						countGraph++;
					}
				
					discs.geometry.attributes.position.needsUpdate = true;
					bateria.geometry.attributes.position.needsUpdate = true;
				}								
			}

			function addPoint(){
				if(!enPausa) {
					//tros[numTrosX,numTrosY].visible=true;
					//app.renderer.render(app.stage);

					/*pos2D[count * 3 + 0] = sat2D[0].position.x;
					pos2D[count * 3 + 1] = sat2D[0].position.y;
					pos2D[count * 3 + 2] = sat2D[0].position.z;	

					if(count==maxPoints-1) {
						for(i=0;i<maxPoints*3-3;i++) {
							pos2D[i]=pos2D[i+3];
						}
					}
					else {
						for(i=count+1;i<maxPoints;i++){							
							pos2D[i* 3 + 2] = -100;
						}
						count++;
					}	*/	

					//trajectoria.geometry.attributes.position.needsUpdate = true;
					
                    for(i=0;i<maxSat;i++) {
                        var laLatitud=(sat2D[i].position.y-centreY)*Math.PI/mAmplada;
                        var laLongitud=(sat2D[i].position.x-centreX)*Math.PI/mAmplada;

                        var distanciaActual=0;
                        dintre[i]=[];
                        for(j=0;j<numEstacions;j++) {
                            distanciaActual=distancia(angleLatEstacio[j],laLatitud,angleLonEstacio[j],laLongitud);
                            if (distanciaActual<parametres.radiProximitat*1000) {
                                dintre[i][j]=true;
                            }
                            else {
                                dintre[i][j]=false;
                            }
                        }                    

                        dintreZona[i]=[];
                        for(j=0;j<numZones;j++) {
                            distanciaActual=distancia(angleLatZona[j],laLatitud,angleLonZona[j],laLongitud);
                            if (distanciaActual<parametres.radiZona*1000) {
                                dintreZona[i][j]=true;
								var numTrosX=Math.floor(((puntSat[0].x-centreMapaX) + 256) / 16);
								var numTrosY=Math.floor(((puntSat[0].y-centreMapaY) + 128) / 16);
								if (tros[numTrosX][numTrosY].visible==false) {
									tros[numTrosX][numTrosY].visible=true;
								}
                            }
                            else {
                                dintreZona[i][j]=false;
                            }
                        }
                    }

					var vectorSat3D=new THREE.Vector3();
					sat3D[0][0].getWorldPosition(vectorSat3D);
					var vectorSatUnitari=new THREE.Vector3().copy(vectorSat3D).multiplyScalar(1/vectorSat3D.length());
					
					ambLlum=true;
					var cosinus=vectorSatUnitari.dot(vectorLlum)
					var radiLlum=vectorSat3D.length()*Math.sin(Math.acos(cosinus));
					if (cosinus>0 && radiLlum<1) {
						ambLlum=false;
					}
				}
			}

			function addLink() {
				for(s=0;s<parametres.nOrb;s++) {
					for(i=0;i<parametres.nSat;i++) {
						var worldSat3D=new THREE.Vector3();
						sat3D[s][i].getWorldPosition(worldSat3D);
						for(j=0;j<numEstacions;j++) {
							if (posLink2D[i][j]!=null) {
								posLink2D[i][j][0]=estacio[j].position.x;
								posLink2D[i][j][1]=estacio[j].position.y;
								posLink2D[i][j][3]=sat2D[i].position.x;
								posLink2D[i][j][4]=sat2D[i].position.y;

								var worldEstacio3D=new THREE.Vector3();
								estacio3D[j].getWorldPosition(worldEstacio3D);

								if (dintre[i][j]) {
									posLink2D[i][j][2]=estacio[j].position.z;
									posLink2D[i][j][5]=sat2D[0].position.z;
									posLink3D[i][j][0]=worldEstacio3D.x;
									posLink3D[i][j][1]=worldEstacio3D.y;
									posLink3D[i][j][2]=worldEstacio3D.z;
									posLink3D[i][j][3]=worldSat3D.x;
									posLink3D[i][j][4]=worldSat3D.y;
									posLink3D[i][j][5]=worldSat3D.z;
								}
								else {
									posLink2D[i][j][2]=0;
									posLink2D[i][j][5]=0;
									for(k=0;k<6;k++) {
										posLink3D[i][j][k]=0;
									}
								}
								link2D[i][j].geometry.attributes.position.needsUpdate = true;
								link3D[i][j].geometry.attributes.position.needsUpdate = true;
							}
						}
					}
				}
			}			

			function veureLine() {
				/*if(parametres.veureLine) {
					scene2D.add(trajectoria);
				} else {
					scene2D.remove(trajectoria);
				}  */
			}

			function canviaSemieix() {
				var eMax=1-satMin*rTerra/(parametres.aOrbita*1000);
				folder1.__controllers[4].max(eMax);
				canviaParametres();
			}

			function canviaExcentricitat() {
				var aMin=satMin*rTerra/(1-parametres.excentricitat)/1000;
				folder1.__controllers[3].min(aMin);
				canviaParametres();
			}

			function canviaParametres() {
				var angleInclinacio=parametres.inclinacio*Math.PI/180;
				var angleLongitud=parametres.longitud*Math.PI/180-Math.PI/2;
				var anglePerigeu=parametres.argPerigeu*Math.PI/180+Math.PI;

				longitudAnterior=angleLongitud;

				var quaternionPerigeu=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,0,1),anglePerigeu);
				var quaternionInclinacio=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0), angleInclinacio);
				var quaternionLongitud=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,0,1), angleLongitud);
				quaternionTerra=new THREE.Quaternion().multiplyQuaternions(quaternionLongitud,new THREE.Quaternion().multiplyQuaternions(quaternionInclinacio,quaternionPerigeu));

				eOrbita=parametres.excentricitat;				

				aOrbita=parametres.aOrbita*1000;
				pOrbita=aOrbita*(1-eOrbita);
				bOrbita=aOrbita*Math.sqrt(1-eOrbita*eOrbita);
				periodeSat=2*Math.PI*Math.sqrt(aOrbita**3/MU);
				omegaSat=2*Math.PI/periodeSat;

				var hores=Math.floor(periodeSat/3600);
				var minuts=Math.floor((periodeSat - 3600 * hores)/60);
				var segons=Math.floor(periodeSat-hores*3600-minuts*60 );
				var stringPeriode="PERÍODE : "+ hores + " hores " + minuts + " minuts " + segons + " segons";
				if (textPeriode!=null) {
					textPeriode.name(stringPeriode);
				}				

			// SAT 2D, 3D
				var mida=0.02*pOrbita/rTerra;
				for(s=0;s<parametres.nOrb;s++) {
					for(i=0;i<maxSat;i++) {
						grupSat[s].remove(sat3D[s][i]);
						//scene2D.remove(sat2D[i]);
						link3D[i]=[];
					}
				}	
				for(s=0;s<parametres.nOrb;s++) {
					for(i=0;i<parametres.nSat;i++) {
						grupSat[s].add(sat3D[s][i]);
						sat3D[s][i].scale.set(mida,mida,mida);
						//scene2D.add(sat2D[i]);
					}
				}				

			// ÒRBITA
				grupMon.remove(orbita);
				var curve = new THREE.EllipseCurve((pOrbita-aOrbita)/rTerra,0,aOrbita/rTerra,bOrbita/rTerra,0,2*Math.PI,false,0);
				var points = curve.getPoints(360);
				var geometryOrbita = new THREE.BufferGeometry().setFromPoints(points);
				orbita = new THREE.Line( geometryOrbita, materialOrbita );
				orbita.quaternion.copy(quaternionTerra);
				grupMon.add(orbita);
				
			// LINK 2D
                for(i=0;i<parametres.nSat;i++) {
                    for(j=0;j<numEstacions;j++) {
                        //scene2D.remove(link2D[i][j]);
                        geometryLink2D = new THREE.BufferGeometry();
                        posLink2D[i][j] = new Float32Array(2 * 3);
                        geometryLink2D.addAttribute('position', new THREE.BufferAttribute(posLink2D[i][j], 3));
                        link2D[i][j] = new THREE.Line(geometryLink2D, materialLink2D);
                        if (ambWebgl) {
                            //scene2D.add(link2D[i][j]);
                        }
                    }
                }

			// LINK 3D (satèl·lit i, estació j, coordenada)
                for(i=0;i<maxSat;i++) {
					for(j=0;j<numEstacions;j++) {
						scene.remove(link3D[i][j]);
                    }					
				}

				for(i=0;i<parametres.nSat;i++) {
                    posLink3D[i]=[];
                    for(j=0;j<numEstacions;j++) {
                        geometryLink3D = new THREE.BufferGeometry();
                        posLink3D[i][j] = new Float32Array(2 * 3);
                        geometryLink3D.addAttribute('position', new THREE.BufferAttribute(posLink3D[i][j], 3));
                        link3D[i][j] = new THREE.Line(geometryLink3D, materialLink3D);
                        scene.add(link3D[i][j]);
                    }
                }

			// UNITATS DE DISC
				//scene2D.remove(discs);
				geometryDiscs = new THREE.BufferGeometry();
				posDiscs = new Float32Array(maxPointsGraph * 3);
				geometryDiscs.addAttribute('position', new THREE.BufferAttribute(posDiscs, 3));
				geometryDiscs.setDrawRange( 1, maxPointsGraph );
				discs = new THREE.Line(geometryDiscs, materialDiscs);
				//scene2D.add(discs);

			// BATERIA
				//scene2D.remove(bateria);
				geometryBateria = new THREE.BufferGeometry();
				posBateria = new Float32Array(maxPointsGraph * 3);
				geometryBateria.addAttribute('position', new THREE.BufferAttribute(posBateria, 3));
				geometryBateria.setDrawRange( 1, maxPointsGraph );
				bateria = new THREE.Line(geometryBateria, materialBateria);
				//scene2D.add(bateria);
		
			// REININCI SIMULACIÓ
				previousTime=new Date().getTime();
				temps=0;
				diaSencer=false;
				count=0;
				countGraph=0;
				steps=0;
				nivellDiscs=100;
				nivellBateria=50;
				for(s=0;s<parametres.nOrb;s++) {
					for(i=0;i<parametres.nSat;i++) {
						angleEscombrat[i]=parametres.anomalia*Math.PI/180 + 2* Math.PI / parametres.nSat * i;
					}
				}
				veureLine();
				for(i=0;i<32;i++) {
					for(j=0;j<16;j++) {
						if (tros[i]!=undefined) {
							tros[i][j].visible=false;
						}
					}
				}
			}

			function onWindowResize() {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				//camera2D.aspect = window.innerWidth / window.innerHeight;
				//camera2D.updateProjectionMatrix();
				renderer.setSize( window.innerWidth * ample, window.innerHeight );
			}

			function animate() {
				requestAnimationFrame( animate );
				render();
			}
			
			function render() {
				if (!enPausa) {
					var currentTime = new Date().getTime();
					interval= currentTime - previousTime;
					temps+=parametres.velAnimacio* interval;
					previousTime = currentTime;	
				}

				if(meshTerra!=null) {
					var quaternionZ=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,0,1), omega*temps);
					meshTerra.quaternion.copy(quaternionZ);
				}

				for (s=0;s<parametres.nOrb;s++) {
					for (i=0;i<parametres.nSat;i++) {
						if (!enPausa) {
							angleEscombrat[i]+=Math.sqrt(MU/((aOrbita*(1-eOrbita**2))**3))*(1+eOrbita*Math.cos(angleEscombrat[i]))**2*parametres.velAnimacio*interval;
						}

						var quaternion=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,0,1),Math.PI + angleEscombrat[i]);
						sat3D[s][i].quaternion.copy(quaternion);
						
						var radi=pOrbita/rTerra*(1+eOrbita)/(1+eOrbita*Math.cos(angleEscombrat[i]));
						sat3D[s][i].position.x=radi*Math.cos(angleEscombrat[i]);
						sat3D[s][i].position.y=radi*Math.sin(angleEscombrat[i]);

						var vectorSatTerra=new THREE.Vector3(sat3D[s][i].position.x,sat3D[s][i].position.y,0);
						vectorSatTerra.applyQuaternion(quaternionTerra);
						vEsferic=coordEsferiques(vectorSatTerra);              										

						var voltes=Math.floor((vEsferic.z - omega * temps + Math.PI) / (2 * Math.PI));
						var longitudMapa=vEsferic.z -omega * temps - voltes * 2 * Math.PI;                  

						longitudAnterior=longitudMapa;	
						
						sat2D[i].position.x=centreX+longitudMapa*mAmplada/Math.PI;
						sat2D[i].position.y=centreY+(Math.PI/2-vEsferic.y)*2*mAlsada/Math.PI;
						sat2D[i].position.z=shiftZ;	

						puntSat[i].x=centreMapaX+longitudMapa*256/Math.PI-4;
						puntSat[i].y=centreMapaY-(Math.PI/2-vEsferic.y)*256/Math.PI-4;
					}
					grupSat[s].quaternion.copy(quaternionTerra);
				}               

				steps++;
				if (temps>0) {
					if (steps % shiftCount == 0) {
						addPoint();	
						addLink();
						addGraph();					
					}
  				} 

				camera.aspect=window.innerWidth/window.innerHeight * ample;
				//camera2D.aspect=window.innerWidth/window.innerHeight * ampleRight;
				camera.updateProjectionMatrix();
				//camera2D.updateProjectionMatrix();

				//renderer.setViewport(0,0,window.innerWidth,window.innerHeight);
                //renderer.clear();	
				//renderer.setViewport(1,1,(1-perCent2D)*window.innerWidth-2,window.innerHeight-2);
                renderer.render( scene, camera );
				//renderer.setViewport((1-perCent2D)*window.innerWidth+1,1,perCent2D*window.innerWidth-2,window.innerHeight-2);
                //renderer.render( scene2D, camera2D );	
			}
		
			function coordEsferiques(vector) {
				var r=vector.length();
				var theta=Math.acos(vector.z/r);
				var phi=Math.atan2(vector.y,vector.x);
				return(new THREE.Vector3(r,theta,phi));
			}

			function canviaMapa() {
				var loader2 = new THREE.TextureLoader();
				loader2.load( 'imatges/'+parametres.mapa3D, function (texture) {
					// MAPA 2D
					//scene2D.remove(mapa2D);
					var geometryMapa2D = new THREE.PlaneGeometry(2*mAmplada, 2*mAlsada );
					var materialMapa2D = new THREE.MeshBasicMaterial(  { map: texture, overdraw: true});
					mapa2D = new THREE.Mesh( geometryMapa2D, materialMapa2D );
					mapa2D.position.x=centreX;
					mapa2D.position.y=centreY;
					mapa2D.position.z=0;
					//scene2D.add( mapa2D );
				} );
				var loader3 = new THREE.TextureLoader();
				loader3.load( 'imatges/'+parametres.mapa3D, function (texture) {
                    // TERRA
					grupMon.remove( meshTerra );
					var geometryTerra = new THREE.SphereGeometry( 1, 20, 20 );
					geometryTerra.rotateX(Math.PI/2);
					var materialTerra = new THREE.MeshLambertMaterial({ map: texture, overdraw: true });
					meshTerra = new THREE.Mesh( geometryTerra, materialTerra );
                    meshTerra.castShadow=true;
					grupMon.add( meshTerra );
					for(j=0;j<numEstacions;j++) {
						meshTerra.add(estacio3D[j]);
					}
				} );	
			}

			function canviaSatelit() {
                var manager = new THREE.LoadingManager();
				manager.onProgress = function ( item, loaded, total ) {
					for(s=0;s<maxOrb;s++) {
						/*for(i=0;i<maxSat;i++) {
							grupSat[s].add(sat3D[s][i]);	
						}*/
					}
				};
				var onProgress = function ( xhr ) {
					if ( xhr.lengthComputable ) {
						var percentComplete = xhr.loaded / xhr.total * 100;
					}
				};
				var onError = function ( xhr ) {
				};
				var loader = new THREE.OBJLoader( manager );
				var fitxerSat="imatges/sat"+parametres.panells+".obj";
				
				loader.load( fitxerSat, function ( object ) {
					object.traverse( function ( child ) {
						if ( child instanceof THREE.Mesh ) {
							child.material=new THREE.MeshStandardMaterial( { color: 0x565758, overdraw: true} );
                            child.receiveShadow = true;
						}
					} );
					object.scale.set(midaSatelit,midaSatelit,midaSatelit);
					for(s=0;s<maxOrb;s++) {
						for(i=0;i<maxSat;i++) {
							grupSat[s].remove(sat3D[s][i]);
							sat3D[s][i]=object.clone();
						}
					}					
				}, onProgress, onError );
			}

			function botoEliminarEstacio() {
				numEstacions--;
				meshTerra.remove(estacio3D[numEstacions]);
				//scene2D.remove(estacio[numEstacions]);
                for(i=0;i<maxSat;i++) {
                    //scene2D.remove(link2D[i][numEstacions]);
                    //scene2D.remove(link3D[i][numEstacions]);
                }
				//scene2D.remove(proximitat[numEstacions]);
				app.stage.removeChild(puntEstacio[numEstacions]);	
				proximitat[numEstacions].clear();

			}

			function botoEliminarZona() {
				numZones--;
				//scene2D.remove(zona[numZones]);
				//scene2D.remove(zonaProx[numZones]);
				app.stage.removeChild(puntZona[numZones]);	
				zonaProx[numZones].clear();
			}

			function botoAfegirEstacio() {
				//if (numEstacions==1) {
					alert("La nova estació s'ha ubicat provisionalment en el mapa.\nPots canviar la ubicació de les estacions arrossegant-les\namb el ratolí.")
				//}
				angleLatEstacio[numEstacions]=10*Math.PI/180;
				angleLonEstacio[numEstacions]=0;

				estacio[numEstacions]= new THREE.Mesh( geometryEstacio, materialEstacio );
				//scene2D.add(estacio[numEstacions]);
				estacio3D[numEstacions]= new THREE.Mesh( geometryEstacio3D, materialEstacio3D );
				meshTerra.add(estacio3D[numEstacions]);	

				puntEstacio[numEstacions]=new PIXI.Sprite(PIXI.loader.resources["imatges/estacio_punt.png"].texture);
				puntEstacio[numEstacions].index=numEstacions;
				puntEstacio[numEstacions].interactive = true;
				puntEstacio[numEstacions].buttonMode = true;
				puntEstacio[numEstacions].on('mousedown', onDragStartEst);
				puntEstacio[numEstacions].on('mousemove', onDragMove);
				puntEstacio[numEstacions].on('mouseup', onDragEndEst);
				app.stage.addChild(puntEstacio[numEstacions]);	

				mouEstacio(numEstacions);
				numEstacions++;
			}

			function botoAfegirZona() {
				//if (numZones==1) {
					alert("La nova zona d\'estudi s'ha ubicat provisionalment en el mapa.\nPots canviar la ubicació de les zones d\'estudi arrossegant-les\namb el ratolí.")
				//}
				angleLatZona[numZones]=45*Math.PI/180;
				angleLonZona[numZones]=90*Math.PI/180;

				zona[numZones]= new THREE.Mesh( geometryZona, materialZona );
				//add(zona[numZones]);

				puntZona[numZones]=new PIXI.Sprite(PIXI.loader.resources["imatges/zona_punt.png"].texture);
				puntZona[numZones].index=numZones;
				puntZona[numZones].interactive = true;
				puntZona[numZones].buttonMode = true;
				puntZona[numZones].on('mousedown', onDragStartZona);
				puntZona[numZones].on('mousemove', onDragMove);
				puntZona[numZones].on('mouseup', onDragEndZona);
				app.stage.addChild(puntZona[numZones]);	

				mouZona(numZones);
				numZones++;
			}

			function canviaRadiProximitat() {	
				var distanciaZona=parametres.radiProximitat*1000/rTerra;			
				for(j=0;j<numEstacions;j++) {		
					//scene2D.remove(proximitat[j]);
					proximitat[j].clear();
					if (proximitat[j]==undefined) {
						proximitat[j] = new PIXI.Graphics();
					}
					app.stage.addChild(proximitat[j]);
					proximitat[j].position.set(centreMapaX,centreMapaY);	
					proximitat[j].lineStyle(1, 0xFF0000);


					var material = new THREE.LineBasicMaterial( { color : 0xff0000 } );
					var geometry = new THREE.Geometry();
					for (i=0;i<=360;i+=stepAngle) {
						azimuth=i*Math.PI/180;
						var novCoord=novesCoordenades(angleLatEstacio[j],angleLonEstacio[j],azimuth,distanciaZona)
						var xProximitat=centreX+novCoord.y*mAmplada/Math.PI;
						var yProximitat=centreY+novCoord.x*mAmplada/Math.PI;
						geometry.vertices.push(new THREE.Vector3(xProximitat, yProximitat, shiftZ) );
						if(i==0) {
							proximitat[j].moveTo(256*novCoord.y/Math.PI,-256*novCoord.x/Math.PI);
						} else {
							proximitat[j].lineTo(256*novCoord.y/Math.PI,-256*novCoord.x/Math.PI);
					}
					}
					//proximitat[j] = new THREE.Line( geometry, material );
					//scene2D.add(proximitat[j]);
				}
			}

			function canviaRadiZona() {	
				var distanciaZona=parametres.radiZona*1000/rTerra;			
				for(j=0;j<numZones;j++) {		
					//scene2D.remove(zonaProx[j]);
					zonaProx[j].clear();
					if (zonaProx[j]==undefined) {
						zonaProx[j] = new PIXI.Graphics();
					}
					app.stage.addChild(zonaProx[j]);
					zonaProx[j].position.set(centreMapaX,centreMapaY);	
					zonaProx[j].lineStyle(1, 0x872D00);

					var material = new THREE.LineBasicMaterial( { color : 0xffc300} );
					var geometry = new THREE.Geometry();
					for (i=0;i<=360;i+=stepAngle) {
						azimuth=i*Math.PI/180;
						var novCoord=novesCoordenades(angleLatZona[j],angleLonZona[j],azimuth,distanciaZona)
						var xProximitat=centreX+novCoord.y*mAmplada/Math.PI;
						var yProximitat=centreY+novCoord.x*mAmplada/Math.PI;
						geometry.vertices.push(new THREE.Vector3(xProximitat, yProximitat, shiftZ) );
						if(i==0) {
							zonaProx[j].moveTo(256*novCoord.y/Math.PI,-256*novCoord.x/Math.PI);
						} else {
							zonaProx[j].lineTo(256*novCoord.y/Math.PI,-256*novCoord.x/Math.PI);
						}
					}
					//zonaProx[j] = new THREE.Line( geometry, material );
					//scene2D.add(zonaProx[j]);
				}
			}

            function canviaNombre() {
                for(i=0;i<maxSat;i++) {
                    for(j=0;j<numEstacions;j++) {
                        scene.remove(link3D[i][j]);
                        //scene2D.remove(link2D[i][j]);
                    }
                }
                canviaParametres();
            }

			function mouEstacio(numEst) {
				estacio[numEst].position.x=centreX+angleLonEstacio[numEst]*mAmplada/Math.PI;
				estacio[numEst].position.y=centreY+angleLatEstacio[numEst]*mAmplada/Math.PI;
				estacio[numEst].position.z=shiftZ;

				estacio3D[numEst].position.x=Math.sin(Math.PI/2-angleLatEstacio[numEst])*Math.cos(angleLonEstacio[numEst]);
				estacio3D[numEst].position.y=Math.sin(Math.PI/2-angleLatEstacio[numEst])*Math.sin(angleLonEstacio[numEst]);
				estacio3D[numEst].position.z=Math.cos(Math.PI/2-angleLatEstacio[numEst]);

				//ZONA DE PROXIMITAT
				//scene2D.remove(proximitat[numEst]);
				//var material = new THREE.LineBasicMaterial( { color : 0xff0000 } );
				var distanciaZona=parametres.radiProximitat*1000/rTerra;
				//var geometry = new THREE.Geometry();

				centreMapaX=window.innerWidth * ampleRight / 2;
				centreMapaY=window.innerHeight/ 2 + 256;

				puntEstacio[numEst].x=centreMapaX+256*angleLonEstacio[numEst]/Math.PI-4;
				puntEstacio[numEst].y=centreMapaY-256*angleLatEstacio[numEst]/Math.PI-4;
				if (proximitat[numEst]==undefined) {
					proximitat[numEst] = new PIXI.Graphics();
				}
				app.stage.addChild(proximitat[numEst]);
				proximitat[numEst].position.set(centreMapaX,centreMapaY);	
				proximitat[numEst].lineStyle(1, 0xFF0000);	

				for (i=0;i<=360;i+=stepAngle) {
					azimuth=i*Math.PI/180;
					var novCoord=novesCoordenades(angleLatEstacio[numEst],angleLonEstacio[numEst],azimuth,distanciaZona)
					//var xProximitat=centreX+novCoord.y*mAmplada/Math.PI;
					//var yProximitat=centreY+novCoord.x*mAmplada/Math.PI;
					if(i==0) {
						proximitat[numEst].moveTo(256*novCoord.y/Math.PI,-256*novCoord.x/Math.PI);
					} else {
						proximitat[numEst].lineTo(256*novCoord.y/Math.PI,-256*novCoord.x/Math.PI);
					}
					//geometry.vertices.push(new THREE.Vector3(xProximitat, yProximitat, shiftZ) );
				}
				//proximitat[numEst] = new THREE.Line( geometry, material );
				//scene2D.add(proximitat[numEst]);
				
			}

			function mouZona(numZona) {
				zona[numZona].position.x=centreX+angleLonZona[numZona]*mAmplada/Math.PI-4;
				zona[numZona].position.y=centreY+angleLatZona[numZona]*mAmplada/Math.PI-4;
				zona[numZona].position.z=shiftZ;

				//scene2D.remove(zonaProx[numZona]);
				//var material = new THREE.LineBasicMaterial( { color : 0xffc300 } );
				var distanciaZona=parametres.radiZona*1000/rTerra;

				centreMapaX=window.innerWidth * ampleRight / 2;
				centreMapaY=window.innerHeight/ 2 + 256;

				puntZona[numZona].x=centreMapaX+256*angleLonZona[numZona]/Math.PI-4;
				puntZona[numZona].y=centreMapaY-256*angleLatZona[numZona]/Math.PI-4;
				if (zonaProx[numZona]==undefined) {
					zonaProx[numZona] = new PIXI.Graphics();
				}
				app.stage.addChild(zonaProx[numZona]);
				zonaProx[numZona].position.set(centreMapaX,centreMapaY);	
				zonaProx[numZona].lineStyle(1, 0x872D00);

				//var geometry = new THREE.Geometry();
				for (i=0;i<=360;i+=stepAngle) {
					azimuth=i*Math.PI/180;
					var novCoord=novesCoordenades(angleLatZona[numZona],angleLonZona[numZona],azimuth,distanciaZona)
					//var xProximitat=centreX+novCoord.y*mAmplada/Math.PI;
					//var yProximitat=centreY+novCoord.x*mAmplada/Math.PI;
					if(i==0) {
						zonaProx[numZona].moveTo(256*novCoord.y/Math.PI,-256*novCoord.x/Math.PI);
					} else {
						zonaProx[numZona].lineTo(256*novCoord.y/Math.PI,-256*novCoord.x/Math.PI);
					}
					//geometry.vertices.push(new THREE.Vector3(xProximitat, yProximitat, shiftZ) );
				}
				//zonaProx[numZona] = new THREE.Line( geometry, material );
				//scene2D.add(zonaProx[numZona]);
			}

			function distancia(lat1,lat2,lon1,lon2) {			 	
				var dfi = (lat2-lat1);
				var dlambda = (lon2-lon1);
				var a = Math.sin(dfi/2) * Math.sin(dfi/2) +
						Math.cos(lat1) * Math.cos(lat2) *
						Math.sin(dlambda/2) * Math.sin(dlambda/2);
				var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
				var d = rTerra * c;
				return d;
			}

			function novesCoordenades(fi1, lambda1, azimuth, distance) {
				var delta = distance;
				var deltafi = delta * Math.cos(azimuth);
				var fi2 = fi1 + deltafi;
				var deltapsi = Math.log(Math.tan(fi2/2+Math.PI/4)/Math.tan(fi1/2+Math.PI/4));
				var q = Math.abs(deltapsi) > 10e-12 ? deltafi / deltapsi : Math.cos(fi1);
				var deltalambda = delta*Math.sin(azimuth)/q;
				var lambda2 = lambda1 + deltalambda;
				if (fi2>Math.PI/2) {fi2=Math.PI/2;}
				if (fi2<-Math.PI/2) {fi2=-Math.PI/2;}
				if (lambda2>Math.PI) {lambda2=Math.PI;}
				if (lambda2<-Math.PI) {lambda2=-Math.PI;}
				return new THREE.Vector3(fi2,lambda2,0);
			}
			
			function botoInfoSensors() {	

			    $.ajax({
    	    		type: "GET",
					contentType: "application/json; charset=utf-8",		    	    		
					url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQgE509E8sh-fxq5pvy9LjjUSC4AHoJaSdqTW0xbFeS9MV6CpT1JeAgk3WhGrlQPBrU1qFX-TXEl3YZ/pub?gid=0&single=true&output=tsv",
        			dataType: "text",
        			success: function(data) {processData(data);}
     			});

				function processData(allText) {
					var csv=allText;
  					var msgDiv="<table style='width:100%'>";

					var lines=csv.split("\n");

  					row_sen = [];

  					for(var i=0; i<lines.length; i++) {
	  					row_sen[i]=lines[i].split("\t");
	  					msgDiv +="<tr>";
	  					if (i>0){
	  						msgDiv +="<td style='border: 1px solid #cacaca; padding:3px;'><input type='checkbox' class='sensor' name='sensor_"+i+"' id='sensor_"+i+"' onchange='calPotencia()'/></td>";		
	  					} else {
	  						msgDiv +="<td style='border: 1px solid #cacaca; padding:3px; background-color: #cacaca'>Sel</td>"
	  					}
  						for(var c=0; c<row_sen[i].length-1; c++) {	  		
  							var senVal=row_sen[i][c];
  							if (c==100){
	  							msgDiv +="<td style='border: 1px solid #cacaca; padding:3px'>"+senVal+"<br><button data-toggle='collapse' data-target='#demo'>Més informació</button><div id='demo' class='collapse'>Lorem ipsum dolor text....</div></td>";
	  						} else {
	  							msgDiv +="<td style='border: 1px solid #cacaca; padding:3px'>"+senVal+"</td>";
	  						}
  						}
  						var senVal=row_sen[i][c];  						
  						msgDiv +="<td style='border: 1px solid #cacaca; padding:3px'><img src='"+senVal+"' style='width:30%'/></td>";
  						//msgDiv +="<td style='border: 1px solid #cacaca; padding:3px'><button id='"+row_sen[i][1].substring(1,row_sen[i][1].length-1)+"'>Més informació</button></td>";  							
	  					msgDiv +="</tr>";  						
  					}
    				msgDiv +="</table>";
    				msgDiv +="<hr>";    
    				msgDiv +="<table style='width:100%'>";
		        	msgDiv +="<tr id='potSensors'><td style='width:50%; background-color: #cacaca'>Potencia necessaria: 0 w</td><td>Planells solars: 0</td></tr>";
    				msgDiv +="<tr id='disSensors'><td style='width:50%; background-color: #cacaca'>Capacitat emmagatzematge necessari: 0Gb </td><td>Discos: 0</td></tr>";    				    				
    				msgDiv +="</table>";    				

					$("#missatge").html(msgDiv);
					$("#finestraInfo").modal('show');		    		
				}
			}	

			var row_mis=[];
			carregaMissions();
			var nM=0; //index de la missió 

			function carregaMissions() {			 	
				$.ajax({
					type: "GET",
					contentType: "application/json; charset=utf-8",		
					url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSjqpRYGZPowGnv70k6bKUOz7CjigpLQIoJZkGHEQlVGpDyH-XNjSMdPiEwtaxFLE_Rjgig-afk8aFD/pub?gid=1727080996&single=true&output=tsv",
					dataType: "text",
					success: function (dades) {
						row_mis=dades.split('\n');
						for (i=0;i<row_mis.length;i++){
							row_mis[i]=row_mis[i].split('\t');
						}
						$("#taulaMissions").show();
						$("#selMissio").show();
					}
				});
			}



			function botoInfoMissions() {			 	
				var msgDiv="<table style='width:100%'>";
				for(var i=0; i<row_mis.length; i++) {
					msgDiv +="<tr>";
					for(var c=0; c<row_mis[i].length; c++) {	  		
						var senVal=row_mis[i][c];				
						if (c==100){
							msgDiv +="<td style='border: 1px solid #cacaca; padding:3px'>"+senVal+"<br><button data-toggle='collapse' data-target='#demo'>Més informació</button><div id='demo' class='collapse'>Lorem ipsum dolor text....</div></td>";
						} else {
							msgDiv +="<td style='border: 1px solid #cacaca; padding:3px'>"+senVal+"</td>";
						}
					}
					var senVal=row_mis[i][c];  									
					msgDiv +="<td style='border: 1px solid #cacaca; padding:3px'><img src='"+senVal+"' style='width:30%'/></td>";
					msgDiv +="</tr>";  						
				}
				msgDiv +="</table>";
				$("#modalHeader").html("Relació de missions");
				$("#missatge").html(msgDiv);
				$("#finestraInfo").modal('show');		    		
			}




			function botoSelMissio() {	
				nM=0;
				if (nM==0){
			    	var max=row_mis.length+1;
			    	var min=1;
					nM=parseInt(Math.random() * (max - min) + min);
				}
				var msgDiv="<div style='width:65%; float: left'>";
					//msgDiv +="<h3>Títol de la missió</td>";
					//msgDiv +="<h2>"+row_mis[nM][1]+"</h2>";
					msgDiv +="<h3>Tipologia de missió:</h3>";
					msgDiv +="<p class='descripcio'>"+row_mis[nM][0]+"</p>";
					msgDiv +="<h3>Descripció</h3>";
					msgDiv +="<p class='descripcio'>"+row_mis[nM][2]+"</p>";
					msgDiv +="<h3>Noticíes i enllaços d'interés</h3>";
					msgDiv +="<p class='descripcio'>"
					    var enll=row_mis[nM][4].split(',');
						for (i=0;i<enll.length;i++){
							msgDiv +="<br><a href='"+enll[i]+"' target='_blank'>Enllaç "+parseInt(i+1)+"</a>";
						}
					msgDiv +="</p>";
				msgDiv +="</div>";	
				msgDiv +="<div style='width:35%; float: right'>";	
					//msgDiv +="<h3>Imatges</h3>";
					msgDiv +="<div><img src='"+row_mis[nM][3]+"' style='max-height:50rem!important; width:100%!important'/></div>";
				msgDiv +="</div>";
				$("#modalHeader").html("Missió a desenvolupar: <br><br><p class='descripcio'>"+row_mis[nM][1])+"</p>";	
				$("#missatge").html(msgDiv);
				$("#finestraInfo").modal('show');	
				$("#selMissio").html("Visualitzar dades de la missió");
			}	



			function botoInfoParametres() {	

			    $.ajax({
    	    		type: "GET",
					contentType: "application/json; charset=utf-8",		    	    		
					url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSoLaetCgRNwwFYVuXVkrvWFLE_tQ3tK4aIyJajkz4n8sRjtK-djm7BiLry1DYLqZImnlDhqOxZeUix/pub?gid=0&single=true&output=tsv",
        			dataType: "text",
        			success: function(data) {processData(data);}
     			});

				function processData(allText) {
					var csv=allText;
  					var msgDiv="<table style='width:100%'>";

					var lines=csv.split("\n");

  					row_sen = [];

  					for(var i=0; i<lines.length; i++) {
	  					row_sen[i]=lines[i].split("\t");
	  					msgDiv +="<tr>";
  						for(var c=0; c<row_sen[i].length-1; c++) {	
  							var senVal=row_sen[i][c];
  							var estil="";
  							if (i==0){
  								var estil="background-color:#cacaca;";
  							} 
  							if (c==100){
	  							msgDiv +="<td style='border: 1px solid #cacaca; padding:3px; "+estil+"'>"+senVal+"<br><button data-toggle='collapse' data-target='#demo'>Més informació</button><div id='demo' class='collapse'>Lorem ipsum dolor text....</div></td>";
	  						} else {
	  							msgDiv +="<td style='border: 1px solid #cacaca; padding:3px; "+estil+"'>"+senVal+"</td>";
	  						}
  						}
  						var senVal=row_sen[i][c];  						
  						msgDiv +="<td style='border: 1px solid #cacaca; padding:3px'><img src='"+senVal+"' style='width:30%'/></td>";
	  					msgDiv +="</tr>";  						
  					}
    				msgDiv +="</table>";
					$("#modalHeader").html("Paràmetres configurables del simulador");	
					$("#missatge").html(msgDiv);
					$("#finestraInfo").modal('show');		    		
				}
			}	




			function calPotencia(){
	   			potSensors =0;
	   			disSensors =0;			   		
	   			for (var s=1; s<row_sen.length; s++) {
	   				if ($("#sensor_"+s).prop("checked")){
	   					potSensors +=parseFloat(row_sen[s][3].substring(1,row_sen[s][3].length-1));
	   					disSensors +=parseFloat(row_sen[s][4].substring(1,row_sen[s][4].length-1));			   			
	   				}
	   			}			   		
	   			var nPanells=Math.round(Math.round(potSensors*10)/1000);ensors
	   			var nDiscs=Math.round(Math.round(disSensors*10)/1000);ensors
	        	$('#potSensors').html("<td>Potencia necessaria: "+potSensors+"</td><td>Panells soensorslars: "+nPanells+"</td>")
				$('#disSensors').html("<td>Capacitat emmagatzematge necessari: "+disSensors+"</tdensors><td>Discos: "+nDiscs+"</td>");
        		folder4.__controllers[0].setValue(nPanells);				
        		folder4.__controllers[1].setValue(nDiscs);				        		
			}	

			function botoInfoSatelit() { 	
				var msgDiv="<iframe src='https://edumet.cat/areatac/zenit/visor-zenit.html' height='600' width='75%'></iframe>" 			
				$("#missatge").html(msgDiv);
				$("#finestraInfo").modal('show');		    		
			}				
		</script>
	</body>
</html>